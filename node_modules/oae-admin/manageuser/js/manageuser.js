/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // The widget container
        $rootel = $('#' + uid);

        var widgetData = null;

        var changePassword = function() {
            var oldPassword = $('#manageuser-current-password', $rootel).val();
            var newPassword = $('#manageuser-new-password', $rootel).val();

            oae.api.authentication.changePassword(widgetData.userId, null, newPassword, function(err) {
                if (err) {
                    if (err.code === 400) {
                        // The user has a non-local account
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'manageuser'),
                            oae.api.i18n.translate('__MSG__YOUR_PASSWORD_CANNOT_BE_CHANGED_HERE__', 'manageuser'),
                            'error'
                        );
                    } else if (err.code === 401) {
                        // Show a 'wrong current password' failure
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'manageuser'),
                            oae.api.i18n.translate('__MSG__THE_PROVIDED_PASSWORD_IS_INCORRECT__', 'manageuser'),
                            'error'
                        );
                    } else {
                        // Show a generic failure notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'manageuser'),
                            oae.api.i18n.translate('__MSG__PASSWORD_UPDATE_FAILED__', 'manageuser'),
                            'error'
                        );
                    }
                } else {
                    // Hide the modal after saving
                    $('#manageuser-modal', $rootel).modal('hide');

                    // Show a success notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__PASSWORD_UPDATED__', 'manageuser'),
                        oae.api.i18n.translate('__MSG__PASSWORD_SUCCESSFULLY_UPDATED__', 'manageuser')
                    );
                }
            });

            return false;
        };

        var setUpValidation = function() {
            oae.api.util.validation().validate($('#manageuser-password', $rootel), {
                'rules': {
                    'manageuser-new-password': {
                        'minlength': 6
                    },
                    'manageuser-retype-password': {
                        'equalTo': '#manageuser-new-password'
                    }
                },
                'messages': {
                    'manageuser-new-password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__'),
                        'minlength': oae.api.i18n.translate('__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__')
                    },
                    'manageuser-retype-password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_REPEAT_YOUR_PASSWORD__'),
                        'passwordmatch': oae.api.i18n.translate('__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__')
                    }
                },
                'submitHandler': changePassword
            });
        };

        /**
         * Sets up the manageuser modal
         */
        var setUpmanageuserModal = function() {
            $(document).on('oae.trigger.manageuser', function(ev, data) {
                console.log(data);
                widgetData = data;
                $('#manageuser-modal', $rootel).modal({
                    'backdrop': 'static'
                });
            });

            setUpValidation();
        };

        setUpmanageuserModal();

    };
});
