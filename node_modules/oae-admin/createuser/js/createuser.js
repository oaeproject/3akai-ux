/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core'], function($, _, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        // Stores the widgetData
        var widgetData = null;

        /**
         * Verify whether or not the entered username already exists as a login id on the tenant.
         *
         * @param  {String}     username                The username we want to check the existence of
         * @param  {Function}   [callback]              Standard callback function.
         * @param  {Boolean}    [callback.available]    Whether or not the username is available
         * @return {Boolean}                            When no callback is provided, this function will be synchronous and will return whether or not the username is available
         */
        var isUserNameAvailable = function(username, callback) {
            // We check if the userid is still available on the tenant.
            // We expect a 200 if it already exists and a 404 if it doesn't exist yet.
            var available = false;
            $.ajax({
                url: '/api/auth/' + widgetData.context.alias + '/exists/' + username,
                async: false,
                success: function() {
                    // The username already exists
                    if (callback) {
                        callback(false);
                    }
                },
                error: function(xhr, textStatus, thrownError) {
                    // The username is still available
                    if (callback) {
                        callback(true);
                    } else {
                        available = true;
                    }
                }
            });
            return available;
        };

        /**
         * Set up the validation on the `create user` form, including the error messages
         */
        var setUpValidation = function() {
            var validateOpts = {
                'rules': {
                    'username': {
                        'minlength': 3,
                        'nospaces': true,
                        'validchars': true,
                        'usernameavailable': true
                    },
                    'password': {
                        'minlength': 6
                    },
                    'password_repeat': {
                        'equalTo': '#createuser-password'
                    }
                },
                'messages': {
                    'firstName': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_FIRST_NAME__', 'createuser')
                    },
                    'lastName': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_LAST_NAME__', 'createuser')
                    },
                    'email': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_VALID_EMAIL_ADDRESS__', 'createuser'),
                        'email': oae.api.i18n.translate('__MSG__THIS_IS_AN_INVALID_EMAIL_ADDRESS__', 'createuser')
                    },
                    'username': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_USERNAME__', 'createuser'),
                        'minlength': oae.api.i18n.translate('__MSG__THE_USERNAME_SHOULD_BE_AT_LEAST_THREE_CHARACTERS_LONG__', 'createuser'),
                        'nospaces': oae.api.i18n.translate('__MSG__THE_USERNAME_SHOULDNT_CONTAIN_SPACES__', 'createuser')
                    },
                    'password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_PASSWORD__', 'createuser'),
                        'minlength': oae.api.i18n.translate('__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__', 'createuser')
                    },
                    'password_repeat': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_REPEAT_PASSWORD__', 'createuser'),
                        'passwordmatch': oae.api.i18n.translate('__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__', 'createuser')
                    }
                },
                'methods': {
                    'validchars': {
                        'method': function(value, element) {
                            return this.optional(element) || !(/[<>\\\/{}\[\]!@#\$%\^&\*,:]+/i.test(value));
                        },
                        'text': oae.api.i18n.translate('__MSG__CREATE_ACCOUNT_INVALIDCHAR__', 'createuser')
                    },
                    'usernameavailable': {
                        'method': function(value, element) {
                            var response = false;
                            isUserNameAvailable(value, function(available) {
                                response = available;
                                // Show the available icon if the username is available, otherwise show the unavailable icon
                                if (available) {
                                    $('#createuser-username-available', $rootel).removeClass('icon-remove').addClass('icon-ok');
                                } else {
                                    $('#createuser-username-available', $rootel).removeClass('icon-ok').addClass('icon-remove');
                                }
                            });
                            return response;
                        },
                        'text': oae.api.i18n.translate('__MSG__THIS_USERNAME_HAS_ALREADY_BEEN_TAKEN__', 'createuser')
                    }
                },
                'submitHandler': createUser
            };
            oae.api.util.validation().validate($('#createuser-form', $rootel), validateOpts);
        };

        /**
         * Create the new user. This will be called after validation has succeeded
         */
        var createUser = function() {
            // Get the form values
            var values = $('#createuser-form').serializeObject();

            // Disable the `create user` button during creation, so it can't be clicked multiple times
            $('button, input', $rootel).prop('disabled', true);

            // Create the user
            var displayName = values.firstName + ' ' + values.lastName;
            var additionalOptions = {
                'email': values.email,
                'tenant': widgetData.context.alias
            };

            oae.api.user.createUser(values.username, values.password, displayName, additionalOptions, null, null, function(err, createdUser) {
                if (err) {
                    // Unlock the `create user` button
                    $('button, input', $rootel).prop('disabled', false);
                } else {
                    // Creating the user succeeded
                    $('#createuser-modal', $rootel).modal('hide');
                }
            });
        };

        /**
         * Initialize the `create user` modal dialog
         */
        var initCreateUser = function() {
            $(document).on('oae.trigger.createuser', function(ev, data) {
                widgetData = data;
                // Trigger the modal dialog
                $('#createuser-modal', $rootel).modal({
                    'backdrop': 'static'
                });

                $('#createuser-modal', $rootel).on('shown.bs.modal', function () {
                    // Set focus to the group name field
                    $('#createuser-firstname', $rootel).focus();
                });
            });
        };

        initCreateUser();
        setUpValidation();

    };
});
