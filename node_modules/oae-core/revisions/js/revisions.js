/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'storyjs-embed'], function($, oae) {

    return function(uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // Stores the timeline data in a format the plugin understands (https://github.com/VeriteCo/TimelineJS#timelinejs)
        var timelineData = {};

        /**
         * Resets the widget to its initial state
         */
        var reset = function() {
            // Reset the timeline
            $('#revisions-timeline', $rootel).empty();

            // Unbind the context event
            $(document).off('oae.context.send');
        };

        /**
         * Initializes the timeline and populates it with the retrieved revision data
         */
        var setUpTimeline = function() {
            createStoryJS({
                'type': 'timeline',
                'width': '800',
                'height': '400',
                'source': timelineData,
                'embed_id': 'revisions-timeline',
                'start_at_end': true
            });
        };

        /**
         * Parses the revision data into a format the timeline plugin understands
         *
         * @param  {Object[]}   revisions   An array of revision objects of a content item
         */
        var parseVersionsIntoTimeline = function(revisions) {
            // Parse the date from the first revision object
            var FirstCreationDate = new Date(parseInt(revisions[0].created, 10));
            var firstYear = FirstCreationDate.getFullYear();
            var firstMonth = FirstCreationDate.getMonth() + 1;
            var firstDay = FirstCreationDate.getDate();
            var firstHour = FirstCreationDate.getHours();

            // Create the timeline data object
            timelineData = {
                'timeline': {
                    'startDate': firstYear + ',' + firstMonth + ',' + firstDay + ',' + firstHour,
                    'type':'default',
                    'date': [] // All revision objects go into the date array.
                }
            };

            // Loop over all returned revisions to create a timeline object for them
            $(revisions).each(function(index, revision) {
                // Parse the date from the revision object
                // The more precise this is the more detailed the timeline will be
                var creationDate = new Date(parseInt(revision.created, 10));
                var year = creationDate.getFullYear();
                var month = creationDate.getMonth() + 1;
                var day = creationDate.getDate();
                var hour = creationDate.getHours();
                var minute = creationDate.getMinutes();
                var second = creationDate.getSeconds();

                // Translate the text for the buttons
                var i18nDownload = oae.api.i18n.translate('__MSG__DOWNLOAD__');
                var i18nRestore = oae.api.i18n.translate('__MSG__RESTORE__');

                // Construct the html for the restore/download buttons.
                // This could be done in a template but would be less performant.
                var dateButtons = '<a href="' + revision.link + '" class="btn btn-primary">' + i18nDownload + '</a>';
                if (index !== 0) {
                    dateButtons += ' <button type="button" class="btn btn-primary revisions-restore" data-revisionid="' + revision.revisionId + '">' + i18nRestore + '</button>';
                }

                // Create the timeline object and push it in the array that will be rendered
                timelineData.timeline.date.push({
                    'startDate': year + ',' + month + ',' + day + ',' + hour + ',' + minute + ',' + second,
                    'endDate': year + ',' + month + ',' + day + ',' + hour + ',' + minute + ',' + second,
                    'headline': oae.api.i18n.translate('__MSG__BY__') + ' ' + oae.api.util.security().encodeForHTML(revision.createdBy.displayName),
                    'text': dateButtons,
                    'asset': {
                        'media': '<img src=' + revision.link + '/>' // TODO: Adjust when https://github.com/sakaiproject/Hilary/issues/456 is merged.
                    }
                });
            });

            // Sets up the timeline with the data that was just prepared
            setUpTimeline();
        };

        /**
         * Restores the content to a previous revision and shows a success or failure notification
         */
        var restoreRevision = function() {
            oae.api.content.restoreRevision(contentProfile.id, $(this).attr('data-revisionid'), function(error) {
                if (!error) {
                    // Hide the modal
                    $('#revisions-modal', $rootel).modal('hide');

                    // Show a success notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REVISION_RESTORED__', 'revisions'),
                        oae.api.i18n.translate('__MSG__REVISION_IS_SUCCESSFULLY_RESTORED__', 'revisions')
                    );

                    // Refresh the content profile
                    $(document).trigger('oae-contentprofile-refresh');
                } else {
                    // Show a failure notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REVISION_NOT_RESTORED__', 'revisions'),
                        oae.api.i18n.translate('__MSG__REVISION_COULD_NOT_BE_RESTORED__', 'revisions'),
                        'error'
                    );
                }
            });
        };

        /**
         * Retrieves the revisions of the content item
         */
        var getRevisions = function() {
            oae.api.content.getRevisions(contentProfile.id, function(error, data) {
                if (!error) {
                    // Parse the revision into a data format that the timeline understands.
                    parseVersionsIntoTimeline(data);
                }
            });
        };

        /**
         * Sets up the modal dialog for the revisions widget
         */
        var setUpVersionsModal = function() {
            // Bind the trigger that opens the modal dialog
            $(document).on('click', '.oae-trigger-revisions', function() {
                $('#revisions-modal', $rootel).modal();
            });

            // Initialize the widget after the modal is shown to avoid rendering issues
            $('#revisions-modal', $rootel).on('shown', function () {
                // Receive the content profile information and get the revisions of the content
                $(document).on('oae.context.send', function(ev, context) {
                    contentProfile = context;
                    getRevisions();
                });

                // Request the content profile information
                $(document).trigger('oae.context.get');
            });

            // Reset the widget when the modal closes
            // There are no other Bootstrap libraries used in the widget so checking that the `hidden` event comes
            // from the modal is not necessary.
            $('#revisions-modal', $rootel).on('hidden', reset);

            // Bind the buttons for restoring to an older revision
            $rootel.on('click', '.revisions-restore', restoreRevision);
        };

        setUpVersionsModal();
    };
});
