casper.test.comment('Widget - Edit group');

/**
 * Verify that the editgroup widget can be triggered
 */
var verifyOpenEditGroup = function() {
    casper.waitForSelector('#group-clip-container .oae-clip-content > button', function() {
        casper.click('#group-clip-container .oae-clip-content > button');
        casper.waitForSelector('button.group-trigger-editgroup', function() {
            casper.test.assertExists('button.group-trigger-editgroup', 'The edit group trigger is present');
            casper.click('button.group-trigger-editgroup');
            casper.wait(1000, function() {
                casper.test.assertVisible('#editgroup-modal', 'Edit group pane is showing after trigger');
                casper.click('#group-clip-container .oae-clip-content > button');
            });
        });
    });
};

/**
 * Verify that the editgroup form elements are present
 */
var verifyEditGroupFormElements = function() {
    // If you only wait for the editgroup-modal it's still not completly loaded
    // So there will be waited till even the modal-footer is loaded
    casper.waitForSelector('#editgroup-modal', function() {
        casper.test.assertExists('form#editgroup-form', 'The edit group form is present');
        casper.test.assertExists('form#editgroup-form #editgroup-name', 'The edit group name field is present');
        casper.test.assertExists('form#editgroup-form #editgroup-description', 'The edit group description field is present');
        casper.test.assertExists('form#editgroup-form #editgroup-joinable-container input[name="oae-joinable-group"]', 'The editgroup joinable options are present');
        casper.test.assertExists('form#editgroup-form button[type="submit"]', 'The edit group form submit button is present');
    });
};

/**
 * Verify that the editgroup form is properly validated:
 *  - Submit empty form
 *  - Submit empty name with description
 */
var verifyEditGroupFormValidation = function() {
    casper.waitForSelector('#editgroup-modal', function() {
        // Submit empty form
        casper.fill('form#editgroup-form', {
            'editgroup-name': '',
            'editgroup-description': ''
        });
        casper.click('#editgroup-modal button[type="submit"]');
        casper.test.assertVisible('#editgroup-name-error', 'Verify validating empty form, name error');

        // Submit empty name with description
        casper.fill('form#editgroup-form', {
            'editgroup-name': '',
            'editgroup-description': 'Group description'
        });
        casper.click('#editgroup-modal button[type="submit"]');
        casper.test.assertVisible('#editgroup-name-error', 'Verify validating form without name');
    });
};

/**
 * Verify that a group can be edited
 */
var verifyEditGroup = function() {
    // Fill the form
    casper.fill('form#editgroup-form', {
        'editgroup-name': 'New group name',
        'editgroup-description': 'New group description'
    });
    // Submit the editdiscussion form
    casper.click('form#editgroup-form button[type="submit"]');
    // Verify that the changes have been persisted
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'The group details were successfully saved');
        casper.test.assertSelectorHasText('#group-clip-container h1', 'New group name', 'The group was successfully renamed to \'New group name\'');
    });
};

casper.start('http://test.oae.com/', function(){
    // Create an user to test with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Log in with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });    

	// Create the group and do the tests on it
    var group1 = null;
    casper.then(function() {
        groupUtil().createGroup(function(group) {
            group1 = group

            casper.thenOpen('http://test.oae.com' + group1.profilePath, function(){
                // Verify that the group can be edited
                casper.then(function() {
                    casper.echo('Verify editgroup modal', 'INFO');
                    verifyOpenEditGroup();
                });

                // Verify that the group form elements are present
                casper.then(function() {
                    casper.echo('Verify editgroup form elements', 'INFO');
                    verifyEditGroupFormElements();
                });

                // Verify that the errors from the group form works
                casper.then(function() {
                    casper.echo('Verify editgroup form validation', 'INFO');
                    verifyEditGroupFormValidation();
                });

                casper.then(function() {
                    casper.echo('Verify group can be edited', 'INFO');
                    verifyEditGroup();
                });
            });
        });
    });

    // Log out again
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});