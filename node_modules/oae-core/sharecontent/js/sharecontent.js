/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'jquery.autosuggest'], function($, oae) {

    return function(uid, showSettings) {

        var $rootel = $('#' + uid);

        var contentId = null;
        var contentName = null;

        var renderShare = function(ev) {
            if (oae.data.me.anon) {
                $('#sharecontent_service_anon').show();
            } else {
                $('#sharecontent_share_users').show();
                $('#sharecontent_share').show();
            }

            contentId = $(this).attr('data-contentid');
            contentName = $(this).attr('data-contentname');
            $('#sharecontent_share', $rootel).attr('data-contentid', contentId);
            var position = $(this).offset();
            position.top += parseInt($(this).css('margin-top').replace('px', '')) + $(this).height() - 10;
            $('#sharecontent_contentname').text(contentName);
            $('.sharecontent_widget').css({
                'top': position.top,
                'left': position.left - ($('.sharecontent_widget').width() / 2)
            });
            $('.sharecontent_widget').show();
            setUpAddThis();
            setupAutoSuggest();
        };

        var getSelectedList = function() {
            var list = $rootel.find('input.as-values').val();
            // this value is a comma-delimited list
            // split it and get rid of any empty values in the array
            list = list.split(',');
            var removed = 0;
            $(list).each(function(i, val) {

               if (val === '') {
                   list.splice(i - removed, 1);
                   removed += 1;
               }
            });

            return list;
        };

        var setupAutoSuggest = function(page) {
            $('#sharecontent_autosuggest', $rootel).autoSuggest('/api/search/general', {
                'selectedItemProp': 'displayName',
                'searchObjProps': 'displayName',
                'selectedValuesProp': 'id',
                'extraParams': {
                    'resourceTypes': ['user', 'group']
                },
                'minChars': 3,
                'neverSubmit': true,
                'showResultListWhenNoMatch': true,
                'retrieveComplete': function(data){
                    return data.results;
                }
            });
        };

        var setUpAddThis = function() {
            // TODO: Replace with config value
            require(['//s7.addthis.com/js/250/addthis_widget.js?%23pubid=' + 'xa-4db72a071927628b' + '&domready=1'], function() {
                var $tbx = $('#toolbox');
                $('a', $tbx).remove();
                var svcs = {facebook: 'Facebook', twitter: 'Twitter', delicious:'Delicious', stumbleupon: 'StumbleUpon', blogger:'Blogger', wordpress:'Wordpress', google:'Google', expanded: 'More'};
                var addThisTitle ='';
                for (var s in svcs) {
                    if (s==='twitter') {
                        addThisTitle = oae.api.i18n.translate('__MSG__SHARE_EXT_MSG1__','sharecontent') + ' ' + contentName.replace(/'/gi,'') + ' ' + oae.api.i18n.translate('__MSG__SHARE_EXT_MSG2__','sharecontent') + ' ' + oae.api.i18n.translate('__MSG__TITLE_PREFIX__');
                    } else{
                        addThisTitle = contentName.replace(/"/gi,'') + ' ' + oae.api.i18n.translate('__MSG__SHARE_EXT_MSG2__','sharecontent') + ' ' + oae.api.i18n.translate('__MSG__TITLE_PREFIX__');
                    }
                    $tbx.append('<a class="addthis_button_' + s + '" addthis:url="' + document.location.protocol + '//' +  document.location.hostname + '/content/' + contentId + '" addthis:title="' + addThisTitle + '"></a>');
                }
                addthis.toolbox('#toolbox');
            });
        };

        var addBinding = function() {
            $(document).on('click', '.oae-trigger-sharecontent', renderShare);

            oae.api.util.hideOnClickOut('.sharecontent_widget', '.oae-trigger-sharecontent');

            $rootel.on('click', '#sharecontent_share', function(ev) {
                var list = getSelectedList();
                oae.api.content.shareContent($(this).attr('data-contentid'), list, function(err) {
                    $('.sharecontent_widget').hide();
                });
            });
        };

        addBinding();

    };
});
