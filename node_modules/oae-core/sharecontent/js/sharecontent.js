/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae/api/oae.core', '/shared/vendor/js/jquery-plugins/jquery.autoSuggest.sakai-edited.js'], function($, oae) {

    return function(uid, showSettings) {

        var $rootel = $('#' + uid);

        var contentId = '';

        var renderShare = function(contentName, contentId, position) {
            oae.api.util.renderTemplate('#sharecontent_template', {
                'contentName': contentName,
                'contentId': contentId
            }, $('#sharecontent_container', $rootel));
            $('.sharecontent_widget').css({
                'top': position.top,
                'left': position.left - ($('.sharecontent_widget').width() / 2)
            });
            $('.sharecontent_widget').show();
            setupAutoSuggest();
        };

        var getSelectedList = function() {
            var list = $rootel.find('input.as-values').val();
            // this value is a comma-delimited list
            // split it and get rid of any empty values in the array
            list = list.split(',');
            var removed = 0;
            $(list).each(function(i, val) {

               if (val === '') {
                   list.splice(i - removed, 1);
                   removed += 1;
               }
            });

            return list;
        };

        var setupAutoSuggest = function(page) {
            $("#sharecontent_autosuggest", $rootel).autoSuggest("/api/search/general/user/", {
                selectedItemProp: "title",
                searchObjProps: "title",
                selectedValuesProp: 'id',
                minChars: 2,
                neverSubmit: true,
                showResultListWhenNoMatch: true,
                retrieveComplete: function(data){
                    return data.results;
                }
            });
        };

        var addBinding = function() {
            $(document).on('click', '.oae-share-button', function(ev) {
                contentId = $(ev.target).attr('data-contentid');
                var contentName = $(this).attr('data-contentname');
                var position = $(this).offset();
                position.top += parseInt($(this).css('margin-top').replace('px', '')) + $(this).height() - 10;
                renderShare(contentName, contentId, position);
            });

            oae.api.util.hideOnClickOut('.sharecontent_widget', '.oae-share-button');

            $rootel.on('click', '#sharecontent_share', function(ev) {
                var list = getSelectedList();
                oae.api.content.shareContent($(this).attr('data-contentid'), list, function(err) {
                    $('.sharecontent_widget').hide();
                });
            });
        };

        var doInit = function() {
            addBinding();
        };

        doInit();
    };
});
