/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        ////////////////////
        // Initialization //
        ////////////////////

        /**
         * Initialize the top navigation by setting up all of the menu items as well as their
         * submenus
         */
        var initTopNavigation = function() {
            initLeftMenu();
            initRightMenu();
            initSubmenus();
        };

        /**
         * Initialize the left hand side of the navigation. There will be different options for logged in and logged out
         * users
         */
        var initLeftMenu = function() {
            if (oae.data.me.anon) {
                oae.api.util.renderTemplate('#topnavigation_left_anonymous_template', null, $('#topnavigation_left'));
            } else {
                oae.api.util.renderTemplate('#topnavigation_left_loggedin_template', null, $('#topnavigation_left'));
            }
        };

        /**
         * Initialize the right hand side of the top navigation. For anonymous users, this will contain a Sign In link
         * and Sign in dropdown. For logged in users, this will show the user's displayname and a submenu showing
         * Logout and My account options
         */
        var initRightMenu = function() {
            if (oae.data.me.anon) {
                oae.api.util.renderTemplate('#topnavigation_right_anonymous_template', null, $('#topnavigation_right_content'));
            } else {
                oae.api.util.renderTemplate('#topnavigation_right_loggedin_template', null, $('#topnavigation_right_content'));
            }
        };

        /**
         * Initialize all of the dropdown menus in the top nvavigation
         */
        var initSubmenus = function() {
            $('.oae-menu-dropdown', $rootel).hover(function() {
                $('.oae-menu-dropdown-container', $(this)).show();
            }, function() {
                $('.oae-menu-dropdown-container', $(this)).hide();
            });
        };

        //////////////////
        // Menu actions //
        //////////////////

        /**
         * Bind an event to the logout link in the logged in user right hand side menu. When this is clicked, the user
         * will be logged out and redirected to the landing page
         */
        var setUpLogout = function() {
            $rootel.on('click', '#topnavigation_logout_link', function() {
                oae.api.authentication.logout(function() {
                    window.location = '/';
                });
            });
        };

        ///////////////////
        // Accessibility //
        ///////////////////

        /**
         * Set up the skip links that can be used by screenreader and keyboard users
         * to jump past the top navigation or jump to the first link of the left navigation
         */
        var setUpSkipLinks = function() {
            // Only show the Skip links if the element 
            // they're pointing to exists on the page
            $('.oae-jump-link', $rootel).each(function() {
                if ($($(this).attr('href')).length > 0) {
                    $(this).show();
                }
            });

            // Focus on the target element when clicking
            // a skip link
            $rootel.on('click', '.oae-jump-link', function() {
                $($(this).attr('href')).focus();
                return false;
            });
        };

        ////////////
        // Search //
        ////////////

        /**
         * Set up the topnavigation search bar. When a query is entered, a live suggest search will be done
         * and the first results will be displayed on the screen.
         */
        var setUpSearch = function() {
            // TODO
            var lastSearchVal = '';
            var searchTimeout = false;

            var doSearch = function() {
                $.ajax({
                    'url': '/api/search/general',
                    'data': {
                        'limit': 9,
                        'q': lastSearchVal,
                        'includeIndirect': false
                    },
                    'success': function(data) {
                        $('#topnavigation_search_results_container').html(oae.api.util.renderTemplate('#search_template', {
                            'data': data,
                            'query': $('#topnavigation_search_input').val()
                        }));
                        $('#topnavigation_search_results_bottom_container').html(oae.api.util.renderTemplate('#search_bottom_template', {
                            'data': data,
                            'query': $('#topnavigation_search_input').val()
                        }));
                        $('#topnavigation_search_results').show();
                    }
                });
            };

            var handleArrowKeyInSearch = function(up) {
                if ($('#topnavigation_search_results_container').find('li').length) {
                    var currentIndex = 0,
                        next = 0;
                    if ($('#topnavigation_search_results_container').find('li.selected').length) {
                        currentIndex = $('#topnavigation_search_results_container').find('li').index($('#topnavigation_search_results_container').find('li.selected')[0]);
                        next = up ? (currentIndex - 1 >= 0 ? currentIndex-1 : -1) : (currentIndex + 1 >= $('#topnavigation_search_results_container').find('li').length ? $('#topnavigation_search_results_container').find('li').length-1 : currentIndex +1);
                        $('#topnavigation_search_results_container').find('li.selected').removeClass('selected');
                    }
                    if (next !== 0 && next === currentIndex) {
                        next = 0;
                    } else if (next === -1) {
                        next = $('#topnavigation_search_results_container').find('li').length - 1;
                    }
                    if (next !== -1) {
                        $('#topnavigation_search_results_container').find('li:eq(' + next + ')').addClass('selected');
                    }
                    return false;
                }
            };

            var handleEnterKeyInSearch = function() {
                if ($('#topnavigation_search_results_container').find('li.selected').length) {
                    document.location = $('#topnavigation_search_results_container').find('li.selected a').attr('href');
                } else {
                    document.location = '/search#l=all&q=' + $.trim($('#topnavigation_search_input').val());
                    $('#topnavigation_search_results').hide();
                }
            };

            // Make sure that the results only disappear when you click outside
            // of the search box and outside of the results box
            oae.api.util.hideOnClickOut('#topnavigation_search_results', '#topnavigation_search_results_container,#topnavigation_search_results_bottom_container,#topnavigation_search_input');

            $('#topnavigation_search_input').keyup(function(evt) {
                var val = $.trim($(this).val());
                if (val !== '' && evt.keyCode !== 16 && val !== lastSearchVal) {
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    searchTimeout = setTimeout(function() {
                        lastSearchVal = val;
                        doSearch();
                    }, 200);
                } else if (val === '') {
                    lastSearchVal = val;
                    $('#topnavigation_search_results').hide();
                }
            });

            $('#topnavigation_search_input').keydown(function(evt) {
                var val = $.trim($(this).val());
                // 40 is down, 38 is up, 13 is enter
                if (evt.keyCode === 40 || evt.keyCode === 38) {
                    handleArrowKeyInSearch(evt.keyCode === 38);
                    evt.preventDefault();
                } else if (evt.keyCode === 13) {
                    handleEnterKeyInSearch();
                    evt.preventDefault();
                }
            });

            $rootel.on('click', '#topnavigation_search .oae-search-button', handleEnterKeyInSearch);
        };

        ///////////
        // Login //
        ///////////

        /**
         * Set up all login related functionality.
         */
        var setUpLogin = function() {
            setUpLoginFocus();
            addLoginValidation();
        };

        /**
         * Make sure that the login dropdown remains visible when clicking inside of it, so it doesn't unneccesarily
         * disappear when accidentally moving out of the dropdown with the mouse cursor
         */
        var setUpLoginFocus = function() {
            // We persist the login dialog when we get focus
            $('#topnavigation_right_content', $rootel).focusin(function() {
                // Make sure the Sign in button is still active
                $('.oae-menu-dropdown', $('#topnavigation_right_content')).addClass('topnavigation-force-submenu-display-title');
                // Make sure the Login dropdown remains visible
                $('#topnavigation_user_options_login_fields').addClass('topnavigation-force-submenu-display');
            });
            // We hide the login dialog when we click outside of the dropdown
            $('html').on('click', function(ev) {
                if ($(ev.target).parents('#topnavigation_right_content').length === 0) {
                    // Make sure the Sign in button is inactive
                    $('.oae-menu-dropdown', $('#topnavigation_right_content')).removeClass('topnavigation-force-submenu-display-title');
                    // Make sure the Login dropdown becomes invisible
                    $('#topnavigation_user_options_login_fields').removeClass('topnavigation-force-submenu-display');
                }
            });
        };

        /**
         * Add validation to the login form 
         */
        var addLoginValidation = function() {
            var $loginForm = $('#topnavigation_user_options_login_form', $rootel);
            var validateOpts = {
                'messages': {
                    'topnavigation_login_username': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_USERNAME__'),
                        'topnavigation_failed_attempt': oae.api.i18n.translate('__MSG__INVALID_USERNAME_OR_PASSWORD__')
                    },
                    'topnavigation_login_password': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__')
                },
                'methods': {
                    'topnavigation_failed_attempt': {
                        'method': function(value, element) {
                            // This class will be added after a failed login attempt and is used
                            // to tell jquery.validate to mark the field as invalid
                            return false;
                        }
                    }
                },
                'insertAfterLabel': true,
                'submitHandler': login
            };
            oae.api.util.validation().validate($loginForm, validateOpts);
        };

        /**
         * Attempt to log in the user with the provided username and password onto the current tenant. This function
         * will only be executed 
         */
        var login = function() {
            // Hide the login button and show a logging in message
            $('#topnavigation_user_options_login_button_login', $rootel).show();
            $('#topnavigation_user_options_login_button_signing_in', $rootel).hide();
            // Sign the user in
            oae.api.authentication.login($('#topnavigation_login_username', $rootel).val(), $('#topnavigation_login_password', $rootel).val(), function(err) {
                if (err) {
                    // Show the login button again
                    $('#topnavigation_user_options_login_button_signing_in', $rootel).hide();
                    $('#topnavigation_user_options_login_button_login', $rootel).show();
                    // Set a `topnavigation_failed_attempt` on the fields to tell jquery.validate
                    // that the field is invalid
                    $('#topnavigation_login_username', $rootel).addClass('topnavigation_failed_attempt');
                    $('#topnavigation_user_options_login_form', $rootel).valid();
                    $('#topnavigation_login_username', $rootel).removeClass('topnavigation_failed_attempt');
                    // Clear the password field
                    $('#topnavigation_login_password', $rootel).val('');
                    // Focus into the username field
                    $('#topnavigation_login_username', $rootel).focus();
                } else {
                    var redirectToMeFrom = ['/', '/index', '/register'];
                    var currentLocation = window.location.pathname;
                    // If a url parameter is available in the URL, we redirect there
                    if ($.deparam.querystring().url) {
                        document.location = $.deparam.querystring().url;
                    // We redirect to the me page if we're on the landing or register page
                    } else if (redirectToMeFrom.indexOf(window.location.pathname) !== -1) {
                        document.location = '/me';
                    // We refresh the current page if we're anywhere else
                    } else {
                        document.location.reload(true);
                    }
                }
            });
        };

        ///////////////////
        // Scroll to top //
        ///////////////////

        /**
         * Scroll to top utility that will be used to help people get back to the top of the page when using a
         * long infinite scroll page.
         */
        var setUpScrollToTop = function() {
            // Scroll to top when the button is clicked
            $rootel.on('click', '#topnavigation_scroll_to_top', function(ev) {
                $('html:not(:animated),body:not(:animated)').animate({scrollTop: 0}, 500);
            });
    
            // Listen to the scroll event to determine when to show the scroll button
            $(window).on('scroll', function(ev) {
                if ($(window).scrollTop() > 800) {
                    $('#topnavigation_scroll_to_top').show('slow');
                } else {
                    $('#topnavigation_scroll_to_top').hide('slow');
                }
            });
        };

        initTopNavigation();
        setUpLogout();
        setUpSkipLinks();
        setUpSearch();
        setUpLogin();
        setUpScrollToTop();

    }
});

