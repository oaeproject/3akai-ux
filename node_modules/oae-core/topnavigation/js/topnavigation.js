/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        ////////////////////
        // Initialization //
        ////////////////////

        /**
         * Initialize the top navigation by setting up all of the menu items as well as their submenus
         */
        var initTopNavigation = function() {
            initLeftMenu();
            initRightMenu();
        };

        /**
         * Initialize the left hand side of the navigation. There will be different options for logged in and logged out
         * users
         */
        var initLeftMenu = function() {
            var template = oae.data.me.anon ? '#topnavigation-left-anonymous-template' : '#topnavigation-left-loggedin-template';
            oae.api.util.template().render(template, null, $('#topnavigation-left'));
        };

        /**
         * Initialize the right hand side of the top navigation. For anonymous users, this will contain a Sign In link
         * and Sign in dropdown. For logged in users, this will show the logout button
         */
        var initRightMenu = function() {
            var template = oae.data.me.anon ? '#topnavigation-right-anonymous-template' : '#topnavigation-right-loggedin-template';
            // Append as the search bar will already be there
            $('#topnavigation-right').append(oae.api.util.template().render(template));
        };


        //////////////////
        // Menu actions //
        //////////////////

        /**
         * Bind an event to the logout link in the logged in user right hand side menu. When this is clicked, the user
         * will be logged out and redirected to the landing page
         */
        var setUpLogout = function() {
            $rootel.on('click', '#topnavigation-signout', function() {
                oae.api.authentication.logout(function() {
                    window.location = '/';
                });
            });
        };

        ///////////////////
        // Accessibility //
        ///////////////////

        /**
         * Set up the skip links that can be used by screenreader and keyboard users
         * to jump past the top navigation or jump to the first link of the left navigation
         */
        var setUpSkipLinks = function() {
            // Only show the Skip links if the element 
            // they're pointing to exists on the page
            $('.oae-skip-link', $rootel).each(function() {
                if ($($(this).attr('href')).length > 0) {
                    $(this).show();
                }
            });

            // Focus on the target element when clicking
            // a skip link
            $rootel.on('click', '.oae-skip-link', function() {
                $($(this).attr('href')).focus();
                return false;
            });
        };

        ////////////
        // Search //
        ////////////

        /**
         * Set up the top navigation search form. When the form is submitted, the user will be
         * redirected to the search page using the entered search query
         */
        var setUpSearch = function() {
            $(document).on('submit', '#topnavigation-search-form', function() {
                // Filter out slashes before redirecting
                window.location = '/search#q=' + $.trim($('#topnavigation-search-query', $(this)).val()).replace(/\//g, '');
                return false;
            });
        };

        /**
         * TODO: Bring this back once we have faceted search
         * Set up the topnavigation search bar. When a query is entered, a live suggest search will be done
         * and the first results will be displayed on the screen.
         *
        var setUpSearch = function() {
            var lastSearchVal = '';
            var searchTimeout = false;

            var doSearch = function() {
                $.ajax({
                    'url': '/api/search/general',
                    'data': {
                        'limit': 9,
                        'q': lastSearchVal,
                        'includeIndirect': false
                    },
                    'success': function(data) {
                        $('#topnavigation-search-results-container').html(oae.api.util.template().render('#search-template', {
                            'data': data,
                            'query': $('#topnav-search-input').val()
                        }));
                        $('#topnavigation-search-results-bottom-container').html(oae.api.util.template().render('#search-bottom-template', {
                            'data': data,
                            'query': $('#topnav-search-input').val()
                        }));
                        $('#topnavigation-search-results-container').show();
                    }
                });
            };

            var handleArrowKeyInSearch = function(up) {
                if ($('#topnavigation-search-results-container').find('li').length) {
                    var currentIndex = 0,
                        next = 0;
                    if ($('#topnavigation-search-results-container').find('li.selected').length) {
                        currentIndex = $('#topnavigation-search-results-container').find('li').index($('#topnavigation-search-results-container').find('li.selected')[0]);
                        next = up ? (currentIndex - 1 >= 0 ? currentIndex-1 : -1) : (currentIndex + 1 >= $('#topnavigation-search-results-container').find('li').length ? $('#topnavigation-search-results-container').find('li').length-1 : currentIndex +1);
                        $('#topnavigation-search-results-container').find('li.selected').removeClass('selected');
                    }
                    if (next !== 0 && next === currentIndex) {
                        next = 0;
                    } else if (next === -1) {
                        next = $('#topnavigation-search-results-container').find('li').length - 1;
                    }
                    if (next !== -1) {
                        $('#topnavigation-search-results-container').find('li:eq(' + next + ')').addClass('selected');
                    }
                    return false;
                }
            };

            var handleEnterKeyInSearch = function() {
                if ($('#topnavigation-search-results-container').find('li.selected').length) {
                    window.location = $('#topnavigation-search-results-container').find('li.selected a').attr('href');
                } else {
                    window.location = '/search#l=all&q=' + $.trim($('#topnav-search-input').val());
                    $('#topnavigation-search-results-container').hide();
                }
            };

            // Make sure that the results only disappear when you click outside
            // of the search box and outside of the results box
            oae.api.util.hideOnClickOut('#topnavigation-search-results-container', '#topnavigation-search-results-container,#topnavigation-search-results-bottom-container,#topnav-search-input');

            $('#topnav-search-input').keyup(function(evt) {
                var val = $.trim($(this).val());
                if (val !== '' && evt.keyCode !== 16 && val !== lastSearchVal) {
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }
                    searchTimeout = setTimeout(function() {
                        lastSearchVal = val;
                        doSearch();
                    }, 200);
                } else if (val === '') {
                    lastSearchVal = val;
                    $('#topnavigation-search-results-container').hide();
                }
            });

            $('#topnav-search-input').keydown(function(evt) {
                var val = $.trim($(this).val());
                // 40 is down, 38 is up, 13 is enter
                if (evt.keyCode === 40 || evt.keyCode === 38) {
                    handleArrowKeyInSearch(evt.keyCode === 38);
                    evt.preventDefault();
                } else if (evt.keyCode === 13) {
                    handleEnterKeyInSearch();
                    evt.preventDefault();
                }
            });

            $('#topnav-search-input').focus(function() {
                $(this).addClass('topnav-search-input-long');
            });

            $('#topnav-search-input').blur(function() {
                if (!$('#topnav-search-input').val()) {
                    $(this).removeClass('topnav-search-input-long');
                }
            });

            $rootel.on('click', '#topnavigation-search .oae-search-button', handleEnterKeyInSearch);
        };*/

        ///////////
        // Login //
        ///////////

        /**
         * Set up all login related functionality.
         */
        var setUpLogin = function() {
            $rootel.on('click', '#topnavigation-signin', function() {
                // Set the cursor focus on the username field when opening the login dropdown. We have
                // to set a timeout to make sure that bootstrap has finished showing the dropdown menu.
                setTimeout(function() {
                    $('#topnavigation-signin-username').focus();
                }, 1);
            });

            addLoginValidation();
        };

        /**
         * Add validation to the login form 
         */
        var addLoginValidation = function() {
            var $loginForm = $('#topnavigation-signin-form', $rootel);
            var validateOpts = {
                'messages': {
                    'topnavigation-signin-username': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_USERNAME__'),
                        'topnavigation-failed-attempt': oae.api.i18n.translate('__MSG__INVALID_USERNAME_OR_PASSWORD__')
                    },
                    'topnavigation-signin-password': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__')
                },
                'methods': {
                    'topnavigation-failed-attempt': {
                        'method': function(value, element) {
                            // This class will be added after a failed login attempt and is used
                            // to tell jquery.validate to mark the field as invalid
                            return false;
                        }
                    }
                },
                'submitHandler': doLogin
            };
            oae.api.util.validation().validate($loginForm, validateOpts);
        };

        /**
         * Attempt to log in the user with the provided username and password onto the current tenant. This function
         * will only be executed 
         */
        var doLogin = function() {
            // Hide the login button and show a logging in message
            $('#topnavigation-signin-button', $rootel).show();
            $('#topnavigation-signin-signing-in', $rootel).hide();
            // Sign the user in
            oae.api.authentication.login($('#topnavigation-signin-username', $rootel).val(), $('#topnavigation-signin-password', $rootel).val(), function(err) {
                if (err) {
                    // Show the login button again
                    $('#topnavigation-signin-signing-in', $rootel).hide();
                    $('#topnavigation-signin-button', $rootel).show();
                    // Set a `topnavigation-failed-attempt` on the fields to tell jquery.validate
                    // that the field is invalid
                    $('#topnavigation-signin-username', $rootel).addClass('topnavigation-failed-attempt');
                    $('#topnavigation-signin-form', $rootel).valid();
                    $('#topnavigation-signin-username', $rootel).removeClass('topnavigation-failed-attempt');
                    // Clear the password field
                    $('#topnavigation-signin-password', $rootel).val('');
                    // Focus into the username field
                    $('#topnavigation-signin-username', $rootel).focus();
                } else {
                    var redirectToMeFrom = ['/', '/index'];
                    var currentLocation = window.location.pathname;
                    // If a url parameter is available in the URL, we redirect there
                    if ($.deparam.querystring().url) {
                        window.location = $.deparam.querystring().url;
                    // We redirect to the me page if we're on the landing or register page
                    } else if (redirectToMeFrom.indexOf(window.location.pathname) !== -1) {
                        window.location = '/me';
                    // We refresh the current page if we're anywhere else
                    } else {
                        window.location.reload(true);
                    }
                }
            });
        };

        ///////////////////
        // Scroll to top //
        ///////////////////

        /**
         * Scroll to top utility that will be used to help people get back to the top of the page when using a
         * long infinite scroll page.
         *
         * TODO: The scroll to top functionality still needs to be re-enabled
        var setUpScrollToTop = function() {
            // Scroll to top when the button is clicked
            $rootel.on('click', '#topnavigation-scroll-to-top', function(ev) {
                $('html:not(:animated),body:not(:animated)').animate({scrollTop: 0}, 500);
            });
    
            // Listen to the scroll event to determine when to show the scroll button
            $(window).on('scroll', function(ev) {
                if ($(window).scrollTop() > 800) {
                    $('#topnavigation-scroll-to-top').show('slow');
                } else {
                    $('#topnavigation-scroll-to-top').hide('slow');
                }
            });
        };*/

        initTopNavigation();
        setUpLogin();
        setUpLogout();
        setUpSkipLinks();
        setUpSearch();
        //setUpScrollToTop();

    }
});

