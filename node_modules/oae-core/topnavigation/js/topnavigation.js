/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        ////////////////////
        // Initialization //
        ////////////////////

        /**
         * Initialize the top navigation by setting up all of the menu items as well as their submenus
         */
        var initTopNavigation = function() {
            initLeftMenu();
            initRightMenu();
        };

        /**
         * Initialize the left hand side of the navigation. There will be different options for logged in and logged out
         * users
         */
        var initLeftMenu = function() {
            var template = oae.data.me.anon ? '#topnavigation-left-anonymous-template' : '#topnavigation-left-loggedin-template';
            oae.api.util.template().render(template, null, $('#topnavigation-left'));
        };

        /**
         * Initialize the right hand side of the top navigation. For anonymous users, this will contain a Sign In link
         * and Sign in dropdown. For logged in users, this will show the logout button
         */
        var initRightMenu = function() {
            var template = oae.data.me.anon ? '#topnavigation-right-anonymous-template' : '#topnavigation-right-loggedin-template';
            // Append as the search bar will already be there
            $('#topnavigation-right').append(oae.api.util.template().render(template));
        };


        //////////////////
        // Menu actions //
        //////////////////

        /**
         * Bind an event to the logout link in the logged in user right hand side menu. When this is clicked, the user
         * will be logged out and redirected to the landing page
         */
        var setUpLogout = function() {
            $rootel.on('click', '#topnavigation-signout', function() {
                oae.api.authentication.logout(function() {
                    window.location = '/';
                });
            });
        };

        ///////////////////
        // Accessibility //
        ///////////////////

        /**
         * Set up the skip links that can be used by screenreader and keyboard users
         * to jump past the top navigation or jump to the first link of the left navigation
         */
        var setUpSkipLinks = function() {
            // Only show the Skip links if the element
            // they're pointing to exists on the page
            $('.oae-skip-link', $rootel).each(function() {
                if ($($(this).attr('href')).length > 0) {
                    $(this).show();
                }
            });

            // Focus on the target element when clicking
            // a skip link
            $rootel.on('click', '.oae-skip-link', function() {
                $($(this).attr('href')).focus();
                return false;
            });
        };

        ////////////
        // Search //
        ////////////

        /**
         * Set up the top navigation search form. When the form is submitted, the user will be
         * redirected to the search page using the entered search query
         */
        var setUpSearch = function() {
            $(document).on('submit', '#topnavigation-search-form', function() {
                var query = $.trim($('#topnavigation-search-query', $(this)).val());
                window.location = '/search/' + oae.api.util.security().encodeForURL(query);
                return false;
            });
        };


        ///////////
        // Login //
        ///////////

        /**
         * Set up all login related functionality.
         */
        var setUpLogin = function() {
            $rootel.on('click', '#topnavigation-signin', function() {
                // Set the cursor focus on the username field when opening the login dropdown. We have
                // to set a timeout to make sure that bootstrap has finished showing the dropdown menu.
                setTimeout(function() {
                    $('#topnavigation-signin-username').focus();
                }, 1);
            });

            addLoginValidation();
        };

        /**
         * Add validation to the login form
         */
        var addLoginValidation = function() {
            var $loginForm = $('#topnavigation-signin-form', $rootel);
            var validateOpts = {
                'messages': {
                    'topnavigation-signin-username': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_USERNAME__'),
                        'topnavigation-failed-attempt': oae.api.i18n.translate('__MSG__INVALID_USERNAME_OR_PASSWORD__')
                    },
                    'topnavigation-signin-password': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__')
                },
                'methods': {
                    'topnavigation-failed-attempt': {
                        'method': function(value, element) {
                            // This class will be added after a failed login attempt and is used
                            // to tell jquery.validate to mark the field as invalid
                            return false;
                        }
                    }
                },
                'submitHandler': doLogin
            };
            oae.api.util.validation().validate($loginForm, validateOpts);
        };

        /**
         * Attempt to log in the user with the provided username and password onto the current tenant. This function
         * will only be executed
         */
        var doLogin = function() {
            // Hide the login button and show a logging in message
            $('#topnavigation-signin-button', $rootel).show();
            $('#topnavigation-signin-signing-in', $rootel).hide();
            // Sign the user in
            oae.api.authentication.login($('#topnavigation-signin-username', $rootel).val(), $('#topnavigation-signin-password', $rootel).val(), function(err) {
                if (err) {
                    // Show the login button again
                    $('#topnavigation-signin-signing-in', $rootel).hide();
                    $('#topnavigation-signin-button', $rootel).show();
                    // Set a `topnavigation-failed-attempt` on the fields to tell jquery.validate
                    // that the field is invalid
                    $('#topnavigation-signin-username', $rootel).addClass('topnavigation-failed-attempt');
                    $('#topnavigation-signin-form', $rootel).valid();
                    $('#topnavigation-signin-username', $rootel).removeClass('topnavigation-failed-attempt');
                    // Clear the password field
                    $('#topnavigation-signin-password', $rootel).val('');
                    // Focus into the username field
                    $('#topnavigation-signin-username', $rootel).focus();
                } else {
                    var redirectToMeFrom = ['/', '/index'];
                    var currentLocation = window.location.pathname;
                    // If a url parameter is available in the URL, we redirect there
                    if ($.url().param('url')) {
                        window.location = $.url().param('url');
                    // We redirect to the me page if we're on the landing or register page
                    } else if (redirectToMeFrom.indexOf(window.location.pathname) !== -1) {
                        window.location = '/me';
                    // We refresh the current page if we're anywhere else
                    } else {
                        window.location.reload(true);
                    }
                }
            });
        };

        ///////////////////
        // Scroll to top //
        ///////////////////

        /**
         * Scroll to top utility that will be used to help people get back to the top of the page when using a
         * long infinite scroll page.
         *
         * TODO: The scroll to top functionality still needs to be re-enabled
        var setUpScrollToTop = function() {
            // Scroll to top when the button is clicked
            $rootel.on('click', '#topnavigation-scroll-to-top', function(ev) {
                $('html:not(:animated),body:not(:animated)').animate({scrollTop: 0}, 500);
            });

            // Listen to the scroll event to determine when to show the scroll button
            $(window).on('scroll', function(ev) {
                if ($(window).scrollTop() > 800) {
                    $('#topnavigation-scroll-to-top').show('slow');
                } else {
                    $('#topnavigation-scroll-to-top').hide('slow');
                }
            });
        };*/

        initTopNavigation();
        setUpLogin();
        setUpLogout();
        setUpSkipLinks();
        setUpSearch();
        //setUpScrollToTop();

    }
});

