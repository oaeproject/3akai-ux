casper.test.comment('Widget - Top navigation');

/**
 * Verify the top navigation elements are present as an anonymous user
 */
var verifyAnonymousTopNavigation = function() {
    casper.waitForSelector('.oae-trigger-register', function() {
        // Verify that the signup button is present
        casper.test.assertExists('.oae-trigger-register', 'The \'Sign up\' button is present');
        // Verify that the institutional logo is present
        casper.test.assertExists('.oae-institutional-logo', 'The institutional logo is present');
        // Verify that the search box is present
        casper.test.assertExists('form#topnavigation-search-form', 'The search form is present');
        casper.test.assertExists('form#topnavigation-search-form input#topnavigation-search-query', 'The search input field is present');
        casper.test.assertExists('form#topnavigation-search-form button[type="submit"]', 'The search submit button is present');
        // Verify that the sign in button and form is present
        casper.test.assertExists('#topnavigation-signin', 'The sign in button is present');
        // Click the sign in button and verify that all form elements are present
        casper.click('#topnavigation-signin');
        casper.test.assertExists('form#topnavigation-signin-form', 'The sign in form is present after click on sign in button');
        casper.test.assertExists('form#topnavigation-signin-form #topnavigation-signin-username', 'The username field is present');
        casper.test.assertExists('form#topnavigation-signin-form #topnavigation-signin-password', 'The password field is present');
        casper.test.assertExists('form#topnavigation-signin-form button[type="submit"]', 'The form submit button is present');
        casper.test.assertExists('form#topnavigation-signin-form button.oae-trigger-register', 'The \'Sign up\' link is present');
        // Verify that there is a container for external log in options
        casper.test.assertExists('#topnavigation-signin-external', 'The external log in container is present');
        // Close the sign in pop-over
        casper.click('#topnavigation-signin');
    });
};

/**
 * Verify the log in functionality and validation
 *     - Submit empty form
 *     - Submit form without password
 *     - Submit form without username
 *     - Attempt login with correct values
 *
 * @param  {String} username   The username of the user to test with
 */
var verifyLogin = function(username) {
    // Open sign in form
    casper.click('#topnavigation-signin');
    // Submit empty form
    casper.fill('form#topnavigation-signin-form', {
        'topnavigation-signin-username': '',
        'topnavigation-signin-password': ''
    }, false);
    casper.click('#topnavigation-signin-button');
    // Verify that an error label is shown
    casper.test.assertExists('#topnavigation-signin-username', 'Successfully validated empty form - username');
    casper.test.assertExists('#topnavigation-signin-password', 'Successfully validated empty form - password');

    // Submit form without password
    casper.fill('form#topnavigation-signin-form', {
        'topnavigation-signin-username': username,
        'topnavigation-signin-password': ''
    }, false);
    casper.click('#topnavigation-signin-button');
    // Verify that an error label is shown
    casper.test.assertExists('#topnavigation-signin-password', 'Successfully validated form without password');

    // Submit form without username
    casper.fill('form#topnavigation-signin-form', {
        'topnavigation-signin-username': '',
        'topnavigation-signin-password': 'password'
    }, false);
    casper.click('#topnavigation-signin-button');
    // Verify that an error label is shown
    casper.test.assertExists('#topnavigation-signin-username', 'Successfully validated form without username');

    // Attempt login with incorrect values
    casper.fill('form#topnavigation-signin-form', {
        'topnavigation-signin-username': 'incorrect',
        'topnavigation-signin-password': 'values'
    }, false);
    casper.click('#topnavigation-signin-button');
    // Verify that an error label is shown
    casper.test.assertExists('#topnavigation-signin-username', 'Successfully validated form with incorrect credentials');

    // Attempt login with correct values
    casper.fill('form#topnavigation-signin-form', {
        'topnavigation-signin-username': username,
        'topnavigation-signin-password': 'password'
    }, false);
    casper.click('#topnavigation-signin-button');
    casper.waitForSelector('#me-clip-container h1', function() {
        casper.test.assertExists('#me-clip-container h1', 'Successfully logged in through the top navigation');
    });
};

/**
 * Verify the top navigation elements are present as a logged in user
 */
var verifyLoggedInTopNavigation = function() {
    casper.waitForSelector('.topnavigation-menu-buttons', function() {
        // Verify that the home button is present
        casper.test.assertExists('.topnavigation-menu-buttons a[href="/me"]', 'The \'Home\' button is present');
        // Verify that the notifications button is present
        casper.test.assertExists('.topnavigation-menu-buttons button.oae-trigger-notifications', 'The \'Notifications\' button is present');
        // Verify that the search box is present
        casper.test.assertExists('form#topnavigation-search-form', 'The search form is present');
        casper.test.assertExists('form#topnavigation-search-form input#topnavigation-search-query', 'The search input field is present');
        casper.test.assertExists('form#topnavigation-search-form button[type="submit"]', 'The search submit button is present');
        // Verify that the logout button is present
        casper.test.assertExists('button#topnavigation-signout', 'The \'Sign out\' button is present');
        casper.click('button#topnavigation-signout');
        casper.waitForSelector('#topnavigation-signin', function() {
            casper.test.assertDoesntExist('button#topnavigation-signout', 'Successfully logged out through the top navigation');
        });
    });
};

/**
 * Verifies the search through the top navigation
 */
var verifyTopNavigationSearch = function() {
    // Fill the search form
    casper.fill('form#topnavigation-search-form', {
        'topnavigation-search-query': 'Apereo OAE'
    });
    // Submit the search form
    casper.click('button#topnavigation-search-icon');
    // Wait for the search page to load
    casper.waitForSelector('#search-query', function() {
        // Verify that the search query got through to the search page
        casper.test.assertEquals(casper.getCurrentUrl().split('/')[4], 'Apereo OAE', 'The search query \'Apereo OAE\' is showing on the search page');
    });
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Verify the top navigation elements as an anonymous user
    casper.then(function() {
        casper.echo('Verify top navigation elemens as an anonymous user', 'INFO');
        verifyAnonymousTopNavigation();
    });

    // Log in
    casper.then(function() {
        casper.echo('Verify logging in through the top navigation', 'INFO');
        verifyLogin(user1.username);
    });

    // Verify the top navigation elements as a logged in user
    casper.then(function() {
        casper.echo('Verify top navigation elemens as a logged in user', 'INFO');
        verifyLoggedInTopNavigation();
    });

    // Verify the top navigation search
    casper.then(function() {
        casper.echo('Verify top navigation search', 'INFO');
        verifyTopNavigationSearch();
    });
});

casper.run(function() {
    this.test.done();
});
