casper.test.begin('Widget - File preview', function(test) {

    /**
     * Verifies that a file preview is shown on the content profile page
     */
    var verifyFilePreview = function() {
        casper.waitForSelector('#filepreview-container', function() {
            test.assertExists('#filepreview-container', 'The file preview container is present');
            test.assertExists('#filepreview-container #filepreview-image-container', 'The image container is present');
            test.assertExists('#filepreview-container #filepreview-image-container img', 'The image is shown on the content profile page');
        });
    };

    /**
     * Verifies that a video preview is shown on the content profile page
     */
    var verifyVideoPreview = function() {
        casper.waitForSelector('#filepreview-container', function() {
            test.assertExists('#filepreview-container', 'The file preview container is present');
        });
    };

    /**
     * Verifies that the etherpad document is shown on the content profile page and that viewers cannot edit the document
     */
    var verifyCollabDocPreview = function(username, documentURL) {
        casper.waitForSelector('#etherpad-container #etherpad-edit-mode', function() {
            test.assertExists('#etherpad-container', 'The etherpad container is present');
            test.assertExists('#etherpad-container #etherpad-edit-mode', 'The etherpad edit mode is present for other manager');
            test.assertExists('#etherpad-container iframe#etherpad-editor', 'The etherpad iframe is present');
            userUtil().doLogOut();
            userUtil().doLogIn(username, 'password');
            casper.thenOpen(documentURL, function() {
                casper.waitForSelector('#etherpad-container #etherpad-view-mode', function() {
                    test.assertExists('#etherpad-container', 'The etherpad container is present for viewer');
                    test.assertExists('#etherpad-container #etherpad-view-mode', 'The etherpad view mode is present for viewer');
                    test.assertDoesntExist('#etherpad-container iframe#etherpad-editor', 'The etherpad edit iframe is not present for viewer');
                });
            });
        });
    };

    casper.start(configUtil().tenantUI, function() {
        // Create a couple of users to test with
        var user1 = null;
        var user2 = null;
        userUtil().createUsers(2, function(users) {
            user1 = users[0];
            user2 = users[1];
        });

        // Log in with that user
        casper.then(function() {
            userUtil().doLogIn(user1.username, configUtil().defaultUserPassword);
        });

        // Verify image previews
        casper.then(function() {
            casper.echo('Verify image preview elements present', 'INFO');
            contentUtil().createFile(null, function(contentURL) {
                casper.thenOpen(configUtil().tenantUI + contentURL);

                casper.then(function() {
                    verifyFilePreview();
                });
            });
        });

        // Verify video previews
        casper.then(function() {
            casper.echo('Verify video preview elements present', 'INFO');
            contentUtil().createFile('tests/casperjs/data/sample-video.mp4', function(contentURL) {
                casper.thenOpen(configUtil().tenantUI + contentURL);

                casper.then(function() {
                    verifyVideoPreview();
                });
            });
        });

        // Verify collaborative document previews
        casper.then(function() {
            casper.echo('Verify collaborative document preview elements present', 'INFO');
            collabDocUtil().createCollabDoc(function(collabDoc) {
                casper.thenOpen(configUtil().tenantUI + collabDoc.profilePath);

                casper.then(function() {
                    verifyCollabDocPreview(user2.username, configUtil().tenantUI + collabDoc.profilePath);
                });
            });
        });

        // Log out at the end of the test
        casper.then(function() {
            userUtil().doLogOut();
        });
    });

    casper.run(function() {
        test.done();
    });
});
