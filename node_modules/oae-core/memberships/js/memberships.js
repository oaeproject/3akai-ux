/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

// load the master sakai object to access all Sakai OAE API methods
require(['jquery', 'sakai/sakai.api.core'], function($, sakai) {

    /**
     * @name sakai_global.memberships
     *
     * @class memberships
     *
     * @description
     * My Memberships lists the groups and worlds that a member is affiliated with
     *
     * @version 0.0.1
     * @param {String} tuid Unique id of the widget
     * @param {Boolean} showSettings Show the settings of the widget or not
     */
    sakai_global.memberships = function(tuid, showSettings) {

        /////////////////////////////
        // Configuration variables //
        /////////////////////////////

        var memberships = {  // global widget data
            isOwnerViewing: false,
            sortOrder: 'modified',
            listStyle: 'list'
        };

        // DOM jQuery Objects
        var $rootel = $('#' + tuid);  // unique container for each widget instance
        var $memberships_items = $('#memberships_items', $rootel);
        var $memberships_nodata = $('#memberships_nodata', $rootel);
        var $memberships_nogroups = $('#memberships_nogroups', $rootel);
        var $memberships_actionbar = $('#memberships_actionbar', $rootel);
        var $memberships_sortby = $('#memberships_sortby', $rootel);
        var $memberships_item = $('.memberships_item', $rootel);
        var $memberships_show_grid = $('.oae-listview-grid', $rootel);
        var $memberships_show_list = $('.oae-listview-list', $rootel);
        var $memberships_nosearchresults = $('#memberships_nosearchresults');
        var $memberships_result_count = $('.oae-search-result-count', $rootel);

        var currentQuery = '';

        ///////////////////////
        // Utility Functions //
        ///////////////////////

        /**
         * Compare the titles of 2 group objects
         *
         * @param {Object} a
         * @param {Object} b
         * @return 1, 0 or -1
         */
        var groupSortName = function(a, b) {
            if (a['name'].toLowerCase() > b['name'].toLowerCase()) {
                return 1;
            } else {
                if (a['name'].toLowerCase() === b['name'].toLowerCase()) {
                    return 0;
                } else {
                    return -1;
                }
            }
        };

        /**
         * Compare the modification date of 2 group objects
         *
         * @param {Object} a
         * @param {Object} b
         * @return 1, 0 or -1
         */
        var groupSortModified = function(a, b) {
            if (a['lastModified'] > b['lastModified']) {
                return 1;
            } else {
                if (a['lastModified'] === b['lastModified']) {
                    return 0;
                } else {
                    return -1;
                }
            }
        };

        ////////////////////
        // Event Handlers //
        ////////////////////

        $memberships_sortby.change(function() {
            var sortSelection = this.options[this.selectedIndex].value;
            if (sortSelection === 'desc') {
                memberships.sortOrder = 'desc';
                $.bbq.pushState({'mso': 'desc'});
            } else if (sortSelection === 'asc') {
                memberships.sortOrder = 'asc';
                $.bbq.pushState({'mso': 'asc'});
            } else {
                memberships.sortOrder = 'modified';
                $.bbq.pushState({'mso': 'modified'});
            }
            doInit();
        });

        ////////////////////////////////////////////
        // Data retrieval and rendering functions //
        ////////////////////////////////////////////

        /**
         * Renders the given groups
         *
         * @param {Object} groups  JSON containing group data
         */
        var render = function(groups) {
            if (groups.length === 0) {
                $memberships_items.hide();
                sakai.api.Util.TemplateRenderer('memberships_nogroups_template', {isMe: memberships.isOwnerViewing}, $memberships_nogroups);
                $memberships_nogroups.show();
                $('.oae-page-header-top-row', $rootel).hide();
                $('.oae-page-header-bottom-row', $rootel).hide();
                return;
            } else {
                if (sakai.data.me.anon) {
                    $('.oae-page-header-bottom-row', $rootel).hide();
                } else {
                    $('.oae-page-header-top-row', $rootel).show();
                    $('.oae-page-header-bottom-row', $rootel).show();
                }
                if (memberships.sortOrder === 'modified') {
                    groups = groups.sort(groupSortModified);
                    groups.reverse();
                } else {
                    groups = groups.sort(groupSortName);
                    if (memberships.sortOrder === 'desc') {
                        groups.reverse();
                    }
                }
                var groupData = [];
                var tempGroupData = sakai.api.Groups.prepareGroupsForRender(groups, sakai.data.me);
                $.each(tempGroupData, function(i, group) {
                    var titleMatch = group['name'] && group['name'].toLowerCase().indexOf(currentQuery.toLowerCase()) >= 0;
                    var descriptionMatch = group['description'] && group['description'].toLowerCase().indexOf(currentQuery.toLowerCase()) >= 0;
                    var idMatch = group.id.toLowerCase().indexOf(currentQuery.toLowerCase()) >= 0;
                    if (titleMatch || descriptionMatch || idMatch) {
                        var groupType = sakai.api.i18n.getValueForKey('OTHER');
                        if (group['sakai:category']) {
                            sakai.api.Util.getTemplates(function(success, templates) {
                                if (success) {
                                    for (var c = 0; c < templates.length; c++) {
                                        if (templates[c].id === group['sakai:category']) {
                                            groupType = sakai.api.i18n.getValueForKey(templates[c].title);
                                        }
                                    }
                                } else {
                                    debug.error('Could not get the group templates');
                                }
                            });
                        }

                        groupData.push({
                            id: group.groupid,
                            url: '/~' + sakai.api.Util.makeSafeURL(group.groupid),
                            picPath: group.picPath,
                            picPathLarge: group.picPathLarge,
                            edit_url: '/dev/group_edit2.html?id=' + group.groupid,
                            title: group['name'],
                            titleShort: group['name-short'],
                            titleShorter: group['name-shorter'],
                            descShort: group['description-short'],
                            descShorter: group['description-shorter'],
                            type: groupType,
                            lastModified: group.lastModified,
                            contentCount: group.counts.contentCount,
                            membersCount: group.counts.membersCount,
                            tags: group.tagsProcessed,
                            userMember: sakai.api.Groups.isCurrentUserAMember(group.groupid,sakai.data.me),
                            joinable: group['sakai:group-joinable']
                        });
                    }
                });
                var json = {
                    groups: groupData,
                    isOwnerViewing: memberships.isOwnerViewing,
                    user_manages: function(group) {
                        if (!group) { return false; }
                        return sakai.api.Groups.isCurrentUserAManager(group.id, sakai.data.me);
                    },
                    sakai: sakai
                };
                $memberships_nodata.hide();
                $memberships_nogroups.hide();
                // Show message that no search results where returned.
                if (!json.groups.length) {
                    $memberships_nosearchresults.show();
                    $memberships_items.hide();
                } else {
                    $memberships_nosearchresults.hide();
                    $memberships_items.show();
                    $('#memberships_sortarea', $rootel).show();
                    $('#memberships_items', $rootel).html(sakai.api.Util.TemplateRenderer(
                        $('#memberships_items_template', $rootel), json));
                }

                // display search results count
                if (currentQuery && groupData.length) {
                    $memberships_result_count.show();
                    var resultLabel = sakai.api.i18n.getValueForKey('RESULTS');
                    if (groupData.length === 1) {
                        resultLabel = sakai.api.i18n.getValueForKey('RESULT');
                    }
                    $memberships_result_count.children('.oae-search-result-count-label').text(resultLabel);
                    $memberships_result_count.children('.oae-search-result-count-count').text(groupData.length);
                } else {
                    $memberships_result_count.hide();
                }

                // display functions available to logged in users
                if (!sakai.data.me.anon) {
                    $('.memberships_item_anonuser').hide();
                    $('.memberships_item_user_functions').show();
                }

                if (memberships.isOwnerViewing) {
                    // disable remove membership button if not allowed to leave
                    var groupsToCheck = [];
                    $.each(groups, function(i, group) {
                        groupsToCheck.push(group.groupid);
                    });
                    sakai.api.Groups.isAllowedToLeave(groupsToCheck, sakai.data.me, function(leaveAllowed) {
                        $.each(leaveAllowed, function(groupid, canLeave) {
                            if (!canLeave) {
                                $('.memberships_leave[data-sakai-entityid="' + groupid + '"]').addClass('mymemberhips_disabled_leave');
                            }
                        });
                    });
                }
            }
        };

        var checkAddingEnabled = function() {
            if ($('.memberships_select_group_checkbox:checked')[0]) {
                $('#memberships_addpeople_button').removeAttr('disabled');
                $('#memberships_message_button').removeAttr('disabled');
            } else {
                $('#memberships_addpeople_button').attr('disabled', true);
                $('#memberships_message_button').attr('disabled', true);
                $('#memberships_select_checkbox').removeAttr('checked');
            }
        };

        var updateMessageAndAddToData = function() {
            var idArr = [];
            var titleArr = [];
            $.each($('.memberships_select_group_checkbox:checked'), function(i, group) {
                idArr.push($(group).attr('data-groupid'));
                titleArr.push($(group).attr('data-grouptitle'));
            });
            $('#memberships_message_button').attr('sakai-entityid', idArr);
            $('#memberships_message_button').attr('sakai-entityname', titleArr);
            $('#memberships_addpeople_button').attr('data-entityid', idArr);
            $('#memberships_addpeople_button').attr('data-entityname', titleArr);
        };

        var removeMembership = function(groupid,groupname) {
            sakai.api.Groups.getRole(sakai.data.me.userId, groupid, function(success,role) {
                sakai.api.Groups.leave(groupid,role,sakai.data.me,function(success) {
                    if (success) {
                        $(window).trigger('lhnav.updateCount', ['memberships', -1]);
                        sakai.api.Util.Modal.close('#memberships_delete_membership_dialog');
                        $('#memberships_item_'+groupid).fadeOut(false, function() {
                            // Show the default message if I have no remaining memberships
                            if ($('#memberships_items li:visible').length === 0) {
                                render({
                                    entry: []
                                });
                            }
                        });
                        sakai.api.Util.notification.show(sakai.api.i18n.getValueForKey('MY_MEMBERSHIPS','memberships'),
                            sakai.api.i18n.getValueForKey('YOU_HAVE_LEFT_GROUP','memberships').replace('${groupname}',groupname),
                            sakai.api.Util.notification.type.INFORMATION);
                    } else {
                        sakai.api.Util.Modal.close('#memberships_delete_membership_dialog');
                        sakai.api.Util.notification.show(sakai.api.i18n.getValueForKey('MY_MEMBERSHIPS','memberships'),
                            sakai.api.i18n.getValueForKey('ERROR_LEAVING_GROUP','memberships').replace('${groupname}',groupname),
                            sakai.api.Util.notification.type.ERROR);
                    }
                });
            });
        };

        var uncheckAll = function() {
            $('#memberships_select_checkbox').removeAttr('checked');
        };


        /////////////////////////////
        // Initialization function //
        /////////////////////////////

        var handleHashChange = function() {
            if (sakai_global.profile.main.data.userId === sakai.data.me.userId) {
                memberships.isOwnerViewing = true;
            }

            sakai.api.Groups.getMemberships(sakai_global.profile.main.data.userId, function(success, groups) {
                if (success) {
                    render(groups);
                }
            });

            sakai.api.Util.TemplateRenderer('memberships_title_template', {
                isMe: memberships.isOwnerViewing,
                user: sakai.api.User.getFirstName(sakai_global.profile.main.data)
            }, $('#memberships_title_container', $rootel));

            uncheckAll();

            $('.oae-listview-options', $rootel).find('div').removeClass('selected');
            memberships.listStyle = $.bbq.getState('ls') || 'list';
            if (memberships.listStyle === 'list') {
                $('#memberships_items', $rootel).removeClass('oae-search-results-grid');
                $memberships_show_list.addClass('selected');
                $memberships_show_list.children().addClass('selected');
            } else {
                $('#memberships_items', $rootel).addClass('oae-search-results-grid');
                $memberships_show_grid.addClass('selected');
                $memberships_show_grid.children().addClass('selected');
            }
        };

        var addBinding = function() {
            $(window).on('hashchanged.memberships.sakai', handleHashChange);

            $('#memberships_search_button').click(function() {
                var q = $.trim($('#memberships_livefilter').val());
                if (q !== currentQuery) {
                    $.bbq.pushState({'mq': q, 'mp': 1});
                    currentQuery = q;
                }
            });

            $memberships_show_list.click(function() {
                $.bbq.pushState({'ls': 'list'});
            });

            $memberships_show_grid.click(function() {
                $.bbq.pushState({'ls': 'grid'});
            });

            $('#memberships_livefilter').keyup(function(ev) {
                var q = $.trim($('#memberships_livefilter').val());
                if (q !== currentQuery && ev.keyCode === 13) {
                    $.bbq.pushState({'mq': q, 'mp': 1});
                    currentQuery = q;
                }
                return false;
            });

            $rootel.on('change', '#memberships_select_checkbox', function() {
                if ($(this).is(':checked')) {
                    $('#memberships_addpeople_button').removeAttr('disabled');
                    $('.memberships_select_group_checkbox').attr('checked', true);
                } else {
                    $('#memberships_addpeople_button').attr('disabled', true);
                    $('.memberships_select_group_checkbox').removeAttr('checked');
                }
                checkAddingEnabled();
                updateMessageAndAddToData();
            });

            $rootel.on('change', '.memberships_select_group_checkbox', function() {
                checkAddingEnabled();
                updateMessageAndAddToData();
            });

            sakai.api.Util.Modal.setup('#memberships_delete_membership_dialog', {
                modal: true,
                overlay: 20,
                toTop: true
            });

            $rootel.on('click', '.oae-actions-delete', function() {
                if ($(this).hasClass('mymemberhips_disabled_leave')) {
                    sakai.api.Util.notification.show(sakai.api.i18n.getValueForKey('GROUP_MEMBERSHIP'),
                        sakai.api.i18n.getValueForKey('UNABLE_TO_LEAVE', 'memberships').replace('${groupname}', $(this).attr('data-sakai-entityname')),
                        sakai.api.Util.notification.type.ERROR);
                } else {
                    var msg = sakai.api.i18n.getValueForKey('ARE_YOU_SURE_YOU_WANT_TO_LEAVE', 'memberships').replace('${groupname}', '<span class="oae-bold">' + $(this).data('sakai-entityname') + '</span>');
                    $('#memberships_are_you_sure').html(msg);
                    $('#memberships_delete_membership_confirm').attr('data-sakai-entityid', $(this).attr('data-sakai-entityid'));
                    $('#memberships_delete_membership_confirm').attr('data-sakai-entityname', $(this).attr('data-sakai-entityname'));
                    sakai.api.Util.Modal.open('#memberships_delete_membership_dialog');
                }
            });

            $('#memberships_delete_membership_confirm').on('click', function() {
                removeMembership($(this).attr('data-sakai-entityid'), $(this).attr('data-sakai-entityname'));
                updateMessageAndAddToData();
            });

            if (sakai_global.profile.main.data.userid !== sakai.data.me.userId) {
                    $('.searchgroups_result_plus',$rootel).on('click', function(ev) {
                    var joinable = $(this).data('group-joinable');
                    var groupid = $(this).attr('data-groupid');
                    var itemdiv = $(this);
                    sakai.api.Groups.addJoinRequest(groupid, function(success) {
                        if (success) {
                            var notimsg = '';
                            if (joinable === 'withauth') {
                                // Don't add green tick yet because they need to be approved.
                                notimsg = sakai.api.i18n.getValueForKey('YOUR_REQUEST_HAS_BEEN_SENT');
                            }
                            else  { // Everything else should be regular success
                                $('#searchgroups_memberimage_'+groupid).show();
                                notimsg = sakai.api.i18n.getValueForKey('SUCCESSFULLY_ADDED_TO_GROUP');
                            }
                            sakai.api.Util.notification.show(sakai.api.i18n.getValueForKey('GROUP_MEMBERSHIP'),
                                notimsg, sakai.api.Util.notification.type.INFORMATION);
                            itemdiv.removeClass('oae-action-icon oae-actions-addtolibrary searchgroups_result_plus');
                            $('#searchgroups_memberimage_' + groupid).show();
                        } else {
                            sakai.api.Util.notification.show(sakai.api.i18n.getValueForKey('GROUP_MEMBERSHIP'),
                                sakai.api.i18n.getValueForKey('PROBLEM_ADDING_TO_GROUP'),
                                sakai.api.Util.notification.type.ERROR);
                        }
                    });
                });
            }
        };

        /**
         * Initialization function that is run when the widget is loaded. Determines
         * which mode the widget is in (settings or main), loads the necessary data
         * and shows the correct view.
         */
        var doInit = function() {
            addBinding();
            currentQuery = $.bbq.getState('mq') || '';
            $('#memberships_livefilter').val(currentQuery);
            memberships.sortOrder = $.bbq.getState('mso') || 'modified';
            $('#memberships_sortby').val(memberships.sortOrder);
            memberships.listStyle = $.bbq.getState('ls') || 'list';

            handleHashChange();
        };

        // run the initialization function when the widget object loads
        doInit();

    };

    // inform Sakai OAE that this widget has loaded and is ready to run
    sakai.api.Widgets.widgetLoader.informOnLoad('memberships');
});