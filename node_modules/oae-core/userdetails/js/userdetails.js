/*!
 * Copyright 2015 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid) {

        // The widget container
        var $rootel = $('#' + uid);

        /**
         * Enable or disable the elements in the user details form to prevent
         * changes during form submission
         *
         * @param  {Boolean}    enable      `true` the form elements should be enabled, `false` if the form elements should be disabled
         */
        var enableDisableUserDetailsForm = function(enable) {
            $('#userdetails-form *', $rootel).prop('disabled', enable);
        };

        /**
         * Update the name and email of the current user
         */
        var editUserDetails = function() {
            enableDisableUserDetailsForm(false);

            acceptTC(function() {
                var params = {
                    'displayName': $.trim($('#userdetails-name', $rootel).val()),
                    'email': $.trim($('#userdetails-email', $rootel).val())
                };
                oae.api.user.updateUser(params, function (err, data) {
                    // If the update failed, enable the form and show an error notification
                    if (err) {
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PROFILE_NOT_EDITED__'),
                            oae.api.i18n.translate('__MSG__PROFILE_DETAILS_EDIT_FAIL__'),
                            'error');

                        return enableDisableUserDetailsForm(true);
                    }

                    // Close the modal and trigger the update event
                    $('#userdetails-modal', $rootel).modal('hide');
                    $(document).trigger('oae.editprofile.done', data);
                });
            });

            // Avoid default form submit behaviour
            return false;
        };

        /**
         * Accept the Terms and Conditions if required. If the request fails,
         * the form will be re-enabled and an appropriate notification will be shown
         *
         * @param  {Function}   callback    Standard callback function
         */
        var acceptTC = function(callback) {
            if (!oae.data.me.needsToAcceptTC) {
                return callback();
            }

            // Accept the terms and conditions
            oae.api.user.acceptTC(function(err) {
                if (err) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__TERMS_AND_CONDITIONS_NOT_ACCEPTED__'),
                        oae.api.i18n.translate('__MSG__TERMS_AND_CONDITIONS_COULD_NOT_BE_ACCEPTED__'),
                        'error');

                    return enableDisableUserDetailsForm(true);
                }

                return callback();
            });
        };

        /**
         * Initialize the Terms and Conditions section
         */
        var setupTermsAndConditions = function() {
            // Bind the Terms and Conditions link
            $rootel.on('click', '#userdetails-accept-terms-and-conditions-button', function() {
                // Get the Terms and Conditions and render them if we hadn't done so already
                if ($('#userdetails-terms-and-conditions-container', $rootel).is(':empty')) {
                    oae.api.user.getTC(function(err, data) {
                        oae.api.util.template().render($('#userdetails-terms-and-conditions-template', $rootel), {
                            'terms': data.text
                        }, $('#userdetails-terms-and-conditions-container', $rootel));
                    });
                }

                // Hide the user details form and show the Terms and Conditions
                $('#userdetails-form', $rootel).hide();
                $('#userdetails-modal', $rootel).addClass('userdetails-modal-termsandconditions');
                $('#userdetails-terms-and-conditions', $rootel).show();

                return false;
            });

            // Bind the `back` button
            $rootel.on('click', '#userdetails-back', function() {
                // Show the user details form and hide the Terms and Conditions
                $('#userdetails-terms-and-conditions', $rootel).hide();
                $('#userdetails-modal', $rootel).removeClass('userdetails-modal-termsandconditions');
                $('#userdetails-form', $rootel).show();

                // As the Terms and Conditions have now been seen by the user,
                // we check the Terms and Conditions checkbox
                $('#userdetails-accept-terms-and-conditions', $rootel).prop('checked', true);
            });
        };

        /**
         * Initialize the user details widget
         */
        var setupUserDetails = function() {
            // Set the value of the name field. If the displayName is invalid, the user has probably
            // logged in through Shibboleth and the IdP didn't realise the actual name. In this
            // case, the name field is left blank
            if (oae.api.util.validation().isValidDisplayName(oae.data.me.displayName)) {
                $('#userdetails-name', $rootel).val(oae.data.me.displayName);
            }

            // Set the value of the email field
            $('#userdetails-email', $rootel).val(oae.data.me.email);

            // Show the Terms and Conditions checkbox if the user needs to accept the
            // Terms and Conditions
            if (oae.data.me.needsToAcceptTC) {
                oae.api.util.template().render($('#userdetails-accept-terms-and-conditions-template', $rootel), null, $('#userdetails-accept-terms-and-conditions-container', $rootel));
                $('#userdetails-accept-terms-and-conditions-container', $rootel).show();
            }

            // Set up validation
            var validateOpts = {
                'messages': {
                    'termsandconditions': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ACCEPT_THE_TERMS_AND_CONDITIONS__')
                    }
                },
                'methods': {
                    'displayname': {
                        'method': oae.api.util.validation().isValidDisplayName,
                        'text': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_VALID_NAME__')
                    }
                },
                'submitHandler': editUserDetails
            };
            oae.api.util.validation().validate($('#userdetails-form', $rootel), validateOpts);

            // Show the modal
            $('#userdetails-modal', $rootel).modal({
                'backdrop': 'static'
            });
        };

        setupUserDetails();
        setupTermsAndConditions();

    };
});
