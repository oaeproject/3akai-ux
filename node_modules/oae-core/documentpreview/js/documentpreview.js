/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['require', 'jquery', 'oae.core'], function(require, $, oae) {

    return function(uid, showSettings, widgetData) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        // Define the container in which we'll be adding pages
        var $container = $('#documentpreview-container', $rootel);

        // If the amount of pixels between the bottom of the container and the current viewport
        // gets lower than this threshold, a new page will be loaded
        var threshold = 200;

        // Variable that keeps track of the page we're on
        var currentPage = 0;

        // Keeps track of whether we're currently trying to add a new page
        var isAdding = false;

        /**
         * Checks if the next page should be loaded by looking at the distance between the scrollbar
         * and the bottom of the container. If the distance is smaller than `threshold` the next page will be
         * added.
         *
         * Regardless of the scroll distance, the first three pages will always be loaded.
         *
         * If all the pages have been loaded, nothing will happen.
         */
        var checkLoadNext = function() {
            var pixelsRemainingUntilBottom = $container.prop('scrollHeight') - $container.height() - $container.scrollTop();
            if (currentPage < widgetData.previews.pageCount && (pixelsRemainingUntilBottom <= threshold || currentPage < 3)) {
                addPage();
            }
        };

        /**
         * Loads the next page and adds it to the DOM
         */
        var addPage = function() {
            // This function can get called multiple times in succession. Check that we're not already loading a page
            if (!isAdding){
                isAdding = true;
                currentPage++;

                // Retrieve the next page. Retrieve it as plain/text otherwise jQuery will parse it and return it as an `HTMLDocumentNode`
                $.ajax({
                    'url': '/api/content/' + widgetData.id + '/revisions/' + widgetData.latestRevisionId + '/previews/page.' + currentPage + '.html?signature=' + widgetData.signature.signature + '&expires=' + widgetData.signature.expires + '&lastmodified=' + widgetData.signature.lastModified ,
                    'dataType': 'text',
                    'success': function(data){
                        // Wrap the HTML fragment in a div, so we can add an annotator on it later on
                        var wrappedFragment = '<div id=page-' + currentPage + '>' + data + '</div>';

                        // Add the page in the DOM
                        $container.append(wrappedFragment);
                        
                        // State that we're done and try to load the next page
                        isAdding = false;
                        checkLoadNext();
                    },
                    'error': function(err){
                        console.log(err);
                    }
                });
            }
        };

        /**
         * Kicks off the document preview loading
         */
        var initDocumentPreview = function() {
            // Append all the CSS files
            $('head').append('<link rel="stylesheet" href="/api/content/' + widgetData.id + '/revisions/' + widgetData.latestRevisionId + '/previews/base.css?signature=' + widgetData.signature.signature + '&expires=' + widgetData.signature.expires + '&lastmodified=' + widgetData.signature.lastModified + '"/>');
            $('head').append('<link rel="stylesheet" href="/api/content/' + widgetData.id + '/revisions/' + widgetData.latestRevisionId + '/previews/fancy.css?signature=' + widgetData.signature.signature + '&expires=' + widgetData.signature.expires + '&lastmodified=' + widgetData.signature.lastModified + '"/>');
            $('head').append('<link rel="stylesheet" href="/api/content/' + widgetData.id + '/revisions/' + widgetData.latestRevisionId + '/previews/lines.css?signature=' + widgetData.signature.signature + '&expires=' + widgetData.signature.expires + '&lastmodified=' + widgetData.signature.lastModified + '"/>');

            // Check if we need to load a page when we scroll down
            $container.on('scroll', checkLoadNext);

            // Load the first page
            checkLoadNext();
        };

        initDocumentPreview();
    };
});
