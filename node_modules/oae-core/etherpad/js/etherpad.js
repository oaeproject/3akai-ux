/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings, contentObj) {


        /////////////////////////////
        // CONFIGURATION VARIABLES //
        /////////////////////////////

        // The widget container
        var $rootel = $('#' + uid);


        ///////////////
        // UTILITIES //
        ///////////////

        /**
         * Sends a POST to `/api/content/:contentid/join` to start editing the etherpad docment.
         * If successfull it hides the view mode and initializes etherpad.
         */
        var showEditMode = function() {
            $.ajax({
                'url': '/api/content/' + contentObj.id + '/join',
                'type': 'POST',
                'success': function(data) {
                    $('#etherpad-view-mode', $rootel).hide();
                    $('#etherpad-edit-mode-content', $rootel).html('<iframe src="' + data.url + '" id="etherpad-editor" />');
                    $('#etherpad-edit-mode', $rootel).show();
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CANNOT_EDIT__', 'etherpad'),
                        oae.api.i18n.translate('__MSG__CANNOT_EDIT_THIS_DOCUMENT__', 'etherpad'),
                        'error');
                }
            });
        };

        /**
         * Shows the view mode of the etherpad document.
         */
        var showViewMode = function() {
            // Hide edit mode
            $('#etherpad-edit-mode', $rootel).hide();

            // Only show the html when there is something to show
            // If there's no content to show, show the default message
            if (contentObj.collabdoc.html && contentObj.collabdoc.html.replace(/(<br>|&nbsp;)/g, '')) {
                $('#etherpad-view-mode-content', $rootel).html(contentObj.collabdoc.html);
            } else {
                oae.api.util.template().render($('#etherpad-no-content-template', $rootel), null, $('#etherpad-view-mode-content', $rootel));
            }

            // Show the view mode container
            $('#etherpad-view-mode', $rootel).show();

            // If the current user is a manager of the content, show the edit button
            if (contentObj.isManager) {
                $('#etherpad-view-mode-edit', $rootel).show();
            }
        };

        /**
         * Publishes the changes to the etherpad document and resets the widget to view mode if successfull.
         */
        var publish = function() {
            $.ajax({
                'url': '/api/content/' + contentObj.id + '/publish',
                'type': 'POST',
                'success': function(data) {
                    // Hide edit mode on success
                    $('#etherpad-edit-mode', $rootel).hide();

                    // Cache the saved data
                    contentObj = data;

                    // Remove the etherpad
                    $('#etherpad-edit-mode-content #etherpad-editor', $rootel).remove();

                    // Return to view mode
                    showViewMode();
                },
                'error': function(jqXHR, textStatus) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__NOT_PUBLISHED__', 'etherpad'),
                        oae.api.i18n.translate('__MSG__DATA_COULD_NOT_BE_PUBLISHED__', 'etherpad'),
                        'error');
                }
            });
        };


        ////////////////////
        // INITIALIZATION //
        ////////////////////

        /**
         * Binds functionality to different actions for the etherpad widget.
         */
        var addBindings = function() {
            $('#etherpad-view-mode-edit', $rootel).on('click', showEditMode);
            $('#etherpad-edit-mode-controls-return', $rootel).on('click', showViewMode);
            $('#etherpad-edit-mode-controls-publish', $rootel).on('click', publish);
        };

        addBindings();
        showViewMode();
    };
});
