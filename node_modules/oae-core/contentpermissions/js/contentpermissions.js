/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core', 'jquery.autoSuggest'], function($, _, oae) {
    return function(uid, showSettings) {

        var $rootel = $('#' + uid);

        /////////////////////////////
        // CONFIGURATION VARIABLES //
        /////////////////////////////

        var contentpermissionsSelectable = '.contentpermissions_selectable > input';
        var contentData = null;
        var contentPermissionsEditList = 'li.contentpermissions_edit';
        var contentpermissionsMemberPermissions = '.contentpermissions_member_permissions';
        var contentpermissionsShareMessageTemplate = 'contentpermissions_share_message_template';

        var $contentpermissionsMembersAutosuggest = false;
        var defaultPermissionPassed = false;
        var visibility = null;
        var visibilityindex = {
            'public': 1,
            'loggedin': 2,
            'private': 3
        };

        var permissionsModal = null;
        var warningModal = null;
        var infinityScroll = false;

        ////////////////////
        // UTIL FUNCTIONS //
        ////////////////////

        /**
         * Closes the widget overlay
         */
        var closeOverlay= function() {
            permissionsModal.close('#contentpermissions_container');
            warningModal.close('#contentpermissions_warning_container');
        };

        var getNewMembers = function() {
            // Get the values from autoSuggest, which is a comma separated list.
            var list = $('#contentpermissions_container input.as-values').val();

            // Clean out the list.
            return _.compact(list.split(','));
        };

        var saveMembers = function() {
            var newRoles = {};
            var hasChanges = false;

            // Check if we have new members.
            var newMembers = getNewMembers();
            var newRole = $('#contentpermissions_members_autosuggest_permissions').val();
            for (var i = 0; i < newMembers.length; i++) {
                newRoles[newMembers[i]] = newRole;
                hasChanges = true;
            }

            // Check if there are any updates to existing members.
            $('#contentpermissions_members_list li.oae-list-item').each(function(i, item) {
                var $item = $(item)
                var oldPermission = $item.attr('data-original-role');

                // Get the new permission, look at the drop down first,
                // However, if the list item has been hidden, that means the principal should be deleted.
                var newPermission = $('select', $item).val();
                if ($item.hasClass('oae-hidden')) {
                    newPermission = false
                }

                // Check if the visibility has changed.
                if (newPermission !== oldPermission) {
                    var principalId = $item.attr('data-id');
                    newRoles[principalId] = newPermission;
                    hasChanges = true;
                }
            });

            // If there are no new members, just close the overlay.
            if (!hasChanges) {
                closeOverlay();

            // If there are changes save them.
            } else {
                oae.api.content.updateMembers(contentData.id, newRoles, function(err) {
                    if (err) {
                        throw new Error('Could not update the members for this piece of content: ' + err.msg);
                    }

                    // We're done.
                    closeOverlay();
                });
            }

        };

        /**
         * Starts the saving process.
         * If the content visibility has changed, that will be saved first.
         * One completion of the content visibility save, the members will be saved.
         */
        var doSave = function() {
            var newVisibilityVal = $.trim($('#contentpermissions_see_container input:checked').val());
            // If the visibility setting has been changed, store that change first.
            if (newVisibilityVal !== contentData.visibility) {
                oae.api.content.updateContent(contentData.id, { 'visibility': newVisibilityVal }, function(err) {
                    if (err) {
                        throw new Error('Could not update the content metadata: ' + err.msg);
                    }

                    // Remember the new visiblity
                    contentData.visibility = newVisibilityVal;

                    // Update the members
                    saveMembers();

                });
            // Otherwise can just save the membership changes.
            } else {
                saveMembers();
            }
        };

        /**
         * Shows a warning if the new visibility is more open than the old one.
         * Otherwise it will save the modal.
         */
        var showWarning = function() {
            var newVisibilityVal = $.trim($('#contentpermissions_see_container input:checked').val());
            if (visibility === newVisibilityVal || visibilityindex[newVisibilityVal] > visibilityindex[visibility]) {
                doSave();
            } else {
                $('#contentpermissions_warning_container_text').html(oae.api.util.template().render('#contentpermissions_warning_container_text_template', {
                    'visibility': newVisibilityVal,
                    'content': contentData.name
                }));
                warningModal.open('#contentpermissions_warning_container');
            }
        };

        var setupAutoSuggest = function(page) {
            // TODO: We need a search that outputs both users and groups.
            $('#contentpermissions_members_autosuggest', $rootel).autoSuggest('/api/search/general', {
                'selectedItemProp': 'displayName',
                'searchObjProps': 'displayName',
                'selectedValuesProp': 'id',
                'extraParams': {
                    'resourceTypes': 'user,group'
                },
                'minChars': 3,
                'neverSubmit': true,
                'showResultListWhenNoMatch': true,
                'startText': oae.api.i18n.translate('__MSG__ENTER_NAME_HERE__'),
                'retrieveComplete': function(data) {
                    return data.results;
                },
                'selectionAdded': function(elem) {
                    $('#contentpermissions_members_autosuggest_permissions').removeAttr('disabled');
                },
                'selectionRemoved': function(elem) {
                    // We need to remove the element from the DOM explicitly.
                    elem.remove();

                    // If there are no other members in the list, we disable the visibility drop down.
                    var members = getNewMembers();
                    if (members.length === 0) {
                        $('#contentpermissions_members_autosuggest_permissions').attr('disabled', 'disabled');
                    }
                }
            });
        };

        ////////////////////
        // INITIALIZATION //
        ////////////////////

        /**
         * Render the default template when no results are found. This function will
         * be called by the infinite scroll plugin
         */
        var handleEmptyResultList = function() {
            oae.api.util.template().render($('#contentpermissions_members_noresults_template'), null, $('.oae-list', $rootel));
        };

        /**
         * Add binding to various elements in the content permissions widget
         */
        var addBinding = function() {
            // Add some candy to the visibility settings.
            $('#contentpermissions_container').on('click', contentpermissionsSelectable, function() {
                $('#contentpermissions_see_container .oae-outer-shadow-container').addClass('contentpermissions_unselected_rbt');
                $(contentpermissionsSelectable).parent().removeClass('oae-outer-shadow-container');
                $(this).parent().addClass('oae-outer-shadow-container');
                $(this).parent().removeClass('contentpermissions_unselected_rbt');
            });

            // Deleting a member can be done by hiding his list item.
            // The save mechanism will pick it up correctly.
            $('#contentpermissions_container').on('click', '.oae-actions-delete', function(eventObject) {
                var $btn = $(eventObject.currentTarget);
                $btn.parents('.oae-list-item').addClass('oae-hidden');
            });

            // General modal save button
            $('#contentpermissions_container').on('click', '#contentpermissions_apply_permissions', showWarning);

            // Confirmation button click.
            $('#contentpermissions_warning_container').on('click', '#contentpermissions_proceedandapply', doSave);
        };

        /**
         * Show the content permissions overlay
         */
        var initializeOverlay = function() {
            permissionsModal = oae.api.util.modal('#contentpermissions_container', {
                'zIndex': 11000
            });
            warningModal = oae.api.util.modal('#contentpermissions_warning_container', {
                'zIndex': 12000
            });
            permissionsModal.open();
        };

        var renderContainer = function() {
            $('.contentpermissions_buttons').show();
            oae.api.util.template().render('#contentpermissions_content_template', {
                'content': contentData,
                'title': contentData.name,
                'oae': oae,
                'defaultPermission': defaultPermissionPassed
            }, $('#contentpermissions_content_container'));


            // Set up the infinite scroll for the memberlist.
            infinityScroll = $('#contentpermissions_members_list', $rootel).infiniteScroll('/api/content/' + contentData.id + '/members', {
                'limit': 12,
                'scrollcontainer': '#contentpermissions_members_list'
            }, '#contentpermissions_members_template', {
                'emptyListProcessor': handleEmptyResultList
            });

            // Setup autosuggestions.
            setupAutoSuggest();
        };

        /**
         * Initializes the content permission widget and invokes the overlay
         */
        var doInit = function() {
            // Render the main modal.
            renderContainer();

            $(window).off('ready.contentprofile.sakai', doInit);
            visibility = contentData.visibility;

            // By default, disable the dropdown next to the autosuggest field.
            // We'll enable it when a user/group has been selected.
            $('#contentpermissions_members_autosuggest_permissions').attr('disabled', 'disabled');

            // Show the overlay.
            initializeOverlay();

            // Scroll to the top.
            $('#contentpermissions_members_list').prop('scrollTop', $('#contentpermissions_members_list').prop('scrollHeight'));
        };

        $(document).on('init.contentpermissions.sakai', function(ev, data) {
            contentData = data.content;
            defaultPermissionPassed = data.newPermission || contentData.visibility;
            doInit();
        });

        addBinding();
    };
});
