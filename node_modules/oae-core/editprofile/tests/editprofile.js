casper.test.comment('Widget - Edit profile');

/**
 * Open the edit profile modal with assertions
 */
var verifyOpenEditProfile = function() {
    casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
        casper.click('#me-clip-container .oae-clip-content > button');
        casper.test.assertExists('.oae-trigger-editprofile', 'Edit profile trigger exists');
        casper.click('.oae-trigger-editprofile');
        casper.wait(1000, function() {
            casper.test.assertVisible('#editprofile-modal', 'Edit profile pane is showing after trigger');
            casper.click('#me-clip-container .oae-clip-content > button');
        });
    });
};

/**
 * Open the edit profile modal
 */
var openEditProfile = function() {
    casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
        casper.click('#me-clip-container .oae-clip-content > button');
        casper.click('.oae-trigger-editprofile');
        casper.wait(1000, function() {
            casper.click('#me-clip-container .oae-clip-content > button');
        });
    });
};

/**
 * Goes through the workflow of editing the user profile
 */
var verifyEditProfile = function() {
    // Verify the form is present
    casper.test.assertExists('form#editprofile-form', 'The edit profile form is present');
    casper.test.assertExists('#editprofile-name', 'The edit profile name field is present');
    casper.test.assertExists('#editprofile-email', 'The edit profile email field is present');
    casper.test.assertExists('input[type="radio"][name="oae-visibility-group"]', 'The edit profile visibility field is present');

    // Fill the form
    casper.fill('form#editprofile-form', {
        'editprofile-name': 'CasperJS test user',
        'editprofile-email': 'test@example.com'
    }, false);

    // Verify the 'edit details' button is present
    casper.test.assertExists('#editprofile-form button[type="submit"]', 'The \'Edit details\' button is present');
    // Click the submit button
    casper.click('#editprofile-form button[type="submit"]');
    // Verify that editing the profile details worked
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Profile successfully edited');
        casper.click('#oae-notification-container .close');
    });
};

/**
 * Verify the form validation by checking the following:
 *     - Try submitting a form without putting in an empty form
 *     - Try submitting a form without putting in a name
 *     - Try submitting a form without putting in an email address
 *     - Try submitting a form while putting in an invalid email address
 */
var verifyEditProfileValidation = function() {
    // Submit an empty form
    // Fill the form
    casper.fill('form#editprofile-form', {
        'editprofile-name': '',
        'editprofile-email': ''
    }, false);
    // Click the submit button
    casper.click('#editprofile-form button[type="submit"]');
    // Verify that an error label is shown
    casper.test.assertExists('#editprofile-name-error', 'Edit profile form successfully validated empty form');

    // Submit a form without a name
    // Fill the form
    casper.fill('form#editprofile-form', {
        'editprofile-name': '',
        'editprofile-email': 'test@example.com'
    }, false);
    // Click the submit button
    casper.click('#editprofile-form button[type="submit"]');
    // Verify that an error label is shown
    casper.test.assertExists('#editprofile-name-error', 'Edit profile form successfully validated empty name');

    // Submit a form without email address
    // Fill the form
    casper.fill('form#editprofile-form', {
        'editprofile-name': 'Roy Trenneman',
        'editprofile-email': ''
    }, false);
    // Click the submit button
    casper.click('#editprofile-form button[type="submit"]');
    // Verify that an error label is shown
    casper.test.assertExists('#editprofile-email-error', 'Edit profile form successfully validated empty email');

    // Submit a form with invalid email address
    // Fill the form
    casper.fill('form#editprofile-form', {
        'editprofile-name': 'Roy Trenneman',
        'editprofile-email': 'incorrect.com'
    }, false);
    // Click the submit button
    casper.click('#editprofile-form button[type="submit"]');
    // Verify that an error label is shown
    casper.test.assertExists('#editprofile-email-error', 'Edit profile form successfully validated incorrect email');
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test editprofile with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Open the editprofile modal
    casper.then(function() {
        casper.echo('Verify open edit profile modal', 'INFO');
        verifyOpenEditProfile();
    });

    // Edit the profile
    casper.then(function() {
        casper.echo('Verify edit profile', 'INFO');
        verifyEditProfile();
    });

    // Verify the edit profile form validation
    casper.thenOpen('http://test.oae.com/me', function() {
        casper.echo('Verify edit profile validation', 'INFO');
        casper.then(openEditProfile);
        casper.then(verifyEditProfileValidation);
    });

    // Log out at the end of the test
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});
