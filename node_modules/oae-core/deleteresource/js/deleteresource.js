/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function (uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // The resource profile will be filled up by requesting the current context.
        // This can be a content item or a discussion item.
        var resourceProfile = null;

        // The i18n strings we'll be using grouped by the resource type.
        var i18nStrings = {
            'content': {
                'title': '__MSG__DELETE_CONTENT__',
                'subtitle': '__MSG__ARE_YOU_SURE_YOU_WANT_TO_DELETE_THIS_CONTENT__',
                'confirm': '__MSG__DELETE_CONTENT__'
            },
            'discussion': {
                'title': '__MSG__DELETE_DISCUSSION__',
                'subtitle': '__MSG__ARE_YOU_SURE_YOU_WANT_TO_DELETE_THIS_DISCUSSION__',
                'confirm': '__MSG__DELETE_DISCUSSION__'
            }
        };

        /**
         * Removes the piece of content, shows a notification and redirects the user after a couple of seconds.
         */
        var removeContent = function() {
            oae.api.content.deleteresource(resourceProfile.id, function(err) {
                if (err) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CONTENT_NOT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__CONTENT_COULD_NOT_BE_DELETED__', 'deleteresource'),
                        'error');
                } else {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CONTENT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__CONTENT_HAS_BEEN_DELETED__', 'deleteresource'),
                        'info');

                    $('#deleteresource-modal', $rootel).modal('hide');

                    setTimeout(oae.api.util.redirect().me, 2000);
                }
            });
        };

        /**
         * Removes the discussion, shows a notification and redirects the user after a couple of seconds.
         */
        var removeDiscussion = function() {
            oae.api.discussion.deleteDiscussion(resourceProfile.id, function(err) {
                if (err) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__DISCUSSION_NOT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__DISCUSSION_COULD_NOT_BE_DELETED__', 'deleteresource'),
                        'error');
                } else {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__DISCUSSION_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__DISCUSSION_HAS_BEEN_DELETED__', 'deleteresource'),
                        'info');

                    $('#deleteresource-modal', $rootel).modal('hide');

                    setTimeout(oae.api.util.redirect().me, 2000);
                }
            });
        };

        /**
         * Sets the correct text strings.
         *
         * @param  {String} resourceType The resource type for which we should show the strings.
         */
        var setI18NStrings = function(resourceType) {
            $('#deleteresource-modal-title', $rootel).text(oae.api.i18n.translate(i18nStrings[resourceType].title, 'deleteresource'));
            $('#deleteresource-modal .modal-body h4', $rootel).text(oae.api.i18n.translate(i18nStrings[resourceType].subtitle, 'deleteresource'));
            $('#deleteresource-confirm', $rootel).text(oae.api.i18n.translate(i18nStrings[resourceType].confirm, 'deleteresource'));
        };

        /**
         * Initializes the modal dialog
         */
        var setUpModal = function() {
            $(document).on('click', '.oae-trigger-deleteresource', function() {
                // Request the content profile information
                $(document).trigger('oae.context.get', 'deleteresource');
            });

            /**
             * Gets executed when we receive the context information.
             * This is the moment when we show the modal.
             *
             * @param  {Object}    ev         The `oae.context.send` event
             * @param  {Object}    context    The profile data for the resource. Either a discussion profile or a content profile.
             */
            $(document).on('oae.context.send.deleteresource', function(ev, context) {
                resourceProfile = context;

                // Use the correct i18n strings.
                setI18NStrings(resourceProfile.resourceType);

                // Show the modal
                $('#deleteresource-modal', $rootel).modal();

                // Binds the 'confirm' button that removes the resource.
                // Depending on the type, we'll bind a different handler.
                if (resourceProfile.resourceType === 'content') {
                    $('#deleteresource-confirm', $rootel).on('click', removeContent);
                } else if (resourceProfile.resourceType === 'discussion') {
                    $('#deleteresource-confirm', $rootel).on('click', removeDiscussion);
                }
            });

            $('#deleteresource-modal', $rootel).on('shown', function() {
                // Set focus to the cancel button
                $('#deleteresource-cancel', $rootel).focus();
            });
        };

        setUpModal();
    };
});
