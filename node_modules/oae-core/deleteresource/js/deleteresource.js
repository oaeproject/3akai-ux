/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function (uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // The resource profile will be filled up by requesting the current context.
        // This can be a content item or a discussion item.
        var resourceProfile = null;

        /**
         * Removes the piece of content, shows a notification and redirects the user after a couple of seconds.
         */
        var removeContent = function() {
            oae.api.content.deleteContent(resourceProfile.id, function(err) {
                if (err) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CONTENT_NOT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__CONTENT_DELETE_FAIL__', 'deleteresource'),
                        'error');
                } else {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CONTENT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__CONTENT_DELETE_SUCCESS__', 'deleteresource'));

                    $('#deleteresource-modal', $rootel).modal('hide');

                    setTimeout(oae.api.util.redirect().me, 2000);
                }
            });
        };

        /**
         * Removes the discussion, shows a notification and redirects the user after a couple of seconds.
         */
        var removeDiscussion = function() {
            oae.api.discussion.deleteDiscussion(resourceProfile.id, function(err) {
                if (err) {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__DISCUSSION_NOT_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__DISCUSSION_DELETE_FAIL__', 'deleteresource'),
                        'error');
                } else {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__DISCUSSION_DELETED__', 'deleteresource'),
                        oae.api.i18n.translate('__MSG__DISCUSSION_DELETE_SUCCESS__', 'deleteresource'));

                    $('#deleteresource-modal', $rootel).modal('hide');

                    setTimeout(oae.api.util.redirect().me, 2000);
                }
            });
        };

        /**
         * Initializes the modal dialog
         */
        var setUpDeleteResourceModal = function() {
            $(document).on('click', '.oae-trigger-deleteresource', function() {
                // Request the content profile information
                $(document).trigger('oae.context.get', 'deleteresource');
            });

            /**
             * Gets executed when we receive the context information.
             * This is the moment when we show the modal.
             *
             * @param  {Object}    ev         The `oae.context.send` event
             * @param  {Object}    context    The profile data for the resource. Either a discussion profile or a content profile.
             */
            $(document).on('oae.context.send.deleteresource', function(ev, context) {
                resourceProfile = context;

                // Render the modal.
                oae.api.util.template().render($('#deleteresource-template', $rootel), {
                    'resource': resourceProfile
                }, $('#deleteresource-modal', $rootel));

                // Binds the 'confirm' button that removes the resource.
                // Depending on the type, we'll bind a different handler.
                if (resourceProfile.resourceType === 'content') {
                    $('#deleteresource-confirm', $rootel).on('click', removeContent);
                } else if (resourceProfile.resourceType === 'discussion') {
                    $('#deleteresource-confirm', $rootel).on('click', removeDiscussion);
                }

                // Show the modal.
                $('#deleteresource-modal', $rootel).modal();
            });
        };

        setUpDeleteResourceModal();
    };
});
