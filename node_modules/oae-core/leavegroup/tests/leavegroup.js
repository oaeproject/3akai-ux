casper.test.begin('Widget - Leave group', function(test) {

    /**
     * Verifies opening the leave group modal with assertions
     */
    var verifyOpenLeaveGroup = function(groupID) {
        casper.waitForSelector('li.oae-list-actions + li', function() {
            // Verify that there is an item in the list that has a checkbox and check it to enable leavegroup
            test.assertExists('li.oae-list-actions + li', 'At least one group is available in the group library');
            casper.click('li input[type="checkbox"][data-id="' + groupID + '"]');
            // Verify that the leavegroup button is enabled and present
            test.assertExists('.oae-list-header-actions .oae-trigger-leavegroup:not([disabled])', 'The leave group trigger exists and is enabled');
            casper.click('.oae-list-header-actions .oae-trigger-leavegroup');
            casper.wait(1000, function() {
                test.assertVisible('#leavegroup-modal', 'The leave group modal is showing after trigger');
            });
        });
    };

    /**
     * Opens the leave group modal
     */
    var openLeaveGroup = function(groupID) {
        casper.waitForSelector('li input[type="checkbox"][data-id="' + groupID + '"]', function() {
            casper.click('li input[type="checkbox"][data-id="' + groupID + '"]');
            casper.click('.oae-list-header-actions .oae-trigger-leavegroup');
            casper.wait(1000);
        });
    };

    /**
     * Verify that the leavegroup elements are present
     */
    var verifyLeaveGroupElements = function() {
        // Verify that the groups that will be left are listed
        test.assertExists('#leavegroup-selected-container li', 'The groups that will be left are listed');
        // Verify there is a warning shown in the UI
        test.assertExists('#leavegroup-modal-content .alert-danger', 'A warning is shown before leaving the groups');
        // Verify the cancel button is present
        test.assertExists('.modal-footer button[data-dismiss="modal"]', 'The cancel button is present');
        // Verify the leave group button is present
        test.assertExists('.modal-footer button#leavegroup-leave', 'The \'Leave group\' button is present');
    };

    /**
     * Verify that a group where you are the only manager cannot be left
     */
    var verifyLeaveGroupAsOnlyManager = function() {
        casper.click('.modal-footer button#leavegroup-leave');
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertExists('#oae-notification-container .alert.alert-error', 'As the only manager I cannot leave a group');
        });
    };

    /**
     * Verify leaving a group that has another manager succeeds
     */
    var verifyLeaveGroupWithOtherManager = function() {
        casper.click('.modal-footer button#leavegroup-leave');
        //casper.click('.modal-footer button[data-dismiss="modal"]');
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Successfully left a group that has one other manager');
        });
    };

    casper.start(configUtil().tenantUI, function() {
        // Create a couple of users to test with
        var user1 = null;
        var user2 = null;
        userUtil().createUsers(2, function(users) {
            user1 = users[0];
            user2 = users[1];
        });

        // Login with user1
        casper.then(function() {
            userUtil().doLogIn(user1.username, configUtil().defaultUserPassword);
        });

        // Create a group to test with
        casper.then(function() {
            groupUtil().createGroup([], [], function(group) {
                casper.thenOpen(configUtil().tenantUI + '/me/groups', function() {
                    // Verify the leavegroup modal
                    casper.then(function() {
                        casper.echo('Verify leave group modal', 'INFO');
                        verifyOpenLeaveGroup(group.id);
                    });

                    // Verify leavegroup elements are present
                    casper.then(function() {
                        casper.echo('Verify leave group elements', 'INFO');
                        verifyLeaveGroupElements();
                    });

                    // Verify leaving a group as the only manager fails
                    casper.then(function() {
                        casper.echo('Verify leave group as only manager fails', 'INFO');
                        verifyLeaveGroupAsOnlyManager();
                    });
                });
            });
        });

        // Create a group with another manager to test with
        casper.then(function() {
            groupUtil().createGroup([], [user2.id], function(group) {
                casper.thenOpen(configUtil().tenantUI + '/me/groups', function() {
                    // Verify leaving a group that has other manager
                    casper.then(function() {
                        casper.echo('Verify leave group that has other manager', 'INFO');
                        casper.then(function() {
                            openLeaveGroup(group.id);
                        });
                        casper.then(function() {
                            verifyLeaveGroupWithOtherManager();
                        });
                    });
                });
            });
        });

        // Log out at the end of the test
        casper.then(function() {
            userUtil().doLogOut();
        });
    });

    casper.run(function() {
        test.done();
    });
});
