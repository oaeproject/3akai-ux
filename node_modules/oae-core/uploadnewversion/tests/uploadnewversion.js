casper.test.comment('Widget - Left hand navigation');

/**
 * Open the upload new version modal with assertions
 */
var verifyOpenUploadNewVersionModal = function() {
    casper.waitForSelector('#content-clip-container .oae-clip-content > button', function() {
        casper.click('#content-clip-container .oae-clip-content > button');
        casper.test.assertExists('.oae-trigger-uploadnewversion', 'Upload new version trigger exists');
        casper.click('.oae-trigger-uploadnewversion');
        casper.wait(1000, function() {
            casper.test.assertVisible('#uploadnewversion-modal', 'Upload new version pane is showing after trigger');
            casper.click('#content-clip-container .oae-clip-content > button');
        });
    });
};

/**
 * Verifies that a new version can be uploaded
 */
var verifyUploadNewVersion = function() {
    // Check if the form exists
    casper.test.assertExists('form#uploadnewversion-form', 'The upload new version form is present');
    // Fill the form with a new version
    casper.fill('form#uploadnewversion-form', {
        'file': 'tests/casperjs/data/apereo.jpg'
    });
    // Verify that a success notification is shown
    casper.waitForSelector('#oae-notification-container .alert', function() {
        casper.test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'New version successfully uploaded');
        casper.click('#oae-notification-container .close');
    });
};

casper.start('http://test.oae.com', function() {
    // Create a couple of users to test with
    var user1 = null;
    userUtil().createUsers(1, function(users) {
        user1 = users[0];
    });

    // Login with that user
    casper.then(function() {
        userUtil().doLogIn(user1.username, 'password');
    });

    // Create a content item, go to the content profile page and open verify opening the modal
    casper.then(function() {
        casper.echo('Verify upload new version modal', 'INFO');
        contentUtil().createFile(function(contentURL) {
            casper.thenOpen('http://test.oae.com' + contentURL, function() {
                verifyOpenUploadNewVersionModal();
            });
        });
    });

    casper.then(function() {
        casper.echo('Verify uploading a new version', 'INFO');
            verifyUploadNewVersion();
    });

    // Log out at the end of the test
    casper.then(function() {
        userUtil().doLogOut();
    });
});

casper.run(function() {
    this.test.done();
});
