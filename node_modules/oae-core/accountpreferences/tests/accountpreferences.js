casper.test.begin('Widget - Account Preferences', function(test) {

    /**
     * Open the account preferences pane with assertions
     */
    var verifyOpenAccountPreferences = function() {
        casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
            casper.click('#me-clip-container .oae-clip-content > button');
            test.assertExists('.oae-trigger-accountpreferences', 'Account preferences trigger exists');
            casper.click('.oae-trigger-accountpreferences');
            casper.waitUntilVisible('#accountpreferences-modal', function() {
                test.assertVisible('#accountpreferences-modal', 'Account preferences pane is showing after trigger');
                casper.click('#me-clip-container .oae-clip-content > button');
            });
        });
    };

    /**
     * Open the account preferences pane without doing any assertions
     */
    var openAccountPreferences = function() {
        casper.waitForSelector('#me-clip-container .oae-clip-content > button', function() {
            casper.click('#me-clip-container .oae-clip-content > button');
            casper.click('.oae-trigger-accountpreferences');
            casper.waitUntilVisible('#accountpreferences-modal', function() {
                casper.click('#me-clip-container .oae-clip-content > button');
            });
        });
    };

    /**
     * Verify changing timezone and language
     */
    var verifyChangeTimezoneAndLanguage = function() {
        // Check if form exists
        test.assertExists('form#accountpreferences-preferences', 'The preferences form is present');
        // Fill in the form
        casper.fill('form#accountpreferences-preferences', {
            'accountpreferences-timezone': 'Pacific/Guam',
            'accountpreferences-language': 'fr_FR'
        }, false);
        // Check if submit button exists
        test.assertExists('form#accountpreferences-preferences button[type="submit"]', 'Preferences form has a submit button');
        // Submit the form
        casper.click('form#accountpreferences-preferences button[type="submit"]');
        // Wait for a notification to show and verify it is not an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Preferences form successfully submitted and stored');
            casper.click('#oae-notification-container .close');
            // Wait a couple of seconds for the reload of the page
            casper.wait(2000);
        });
        // Open the account preferences pane to verify the changes have been persisted.
        casper.then(function() {
            openAccountPreferences();
        });
        // Verify the changes
        test.assertField('accountpreferences-timezone', 'Pacific/Guam', 'Timezone is the one expected');
        test.assertField('accountpreferences-language', 'fr_FR', 'Language is the one expected');
    };

    /**
     * Verify changing password
     */
    var verifyChangePassword = function() {
        // Switch to the password settings
        casper.click('a[href="#accountpreferences-password"]', 'Switch to password tab');
        // Check if form exists
        test.assertExists('form#accountpreferences-password', 'The password form is present');
        // Fill in the form
        casper.fill('form#accountpreferences-password', {
            'accountpreferences-current-password': 'password',
            'accountpreferences-new-password': 'testtest',
            'accountpreferences-retype-password': 'testtest'
        }, false);
        // Check if submit button exists
        test.assertExists('form#accountpreferences-password button[type="submit"]', 'Password form has a submit button');
        // Submit the form
        casper.click('form#accountpreferences-password button[type="submit"]', 'Submit the form');
        // Wait for a notification to show and verify it is not an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertDoesntExist('#oae-notification-container .alert.alert-error', 'Password form successfully submitted and stored');
            casper.click('#oae-notification-container .close');
        });
    };

    /**
     * Verify the form validation by checking the following:
     *     - Try submitting a form without putting in any values
     *     - Try submitting a form with an incorrect current password
     *     - Try submitting a form with non-matching new password
     */
    var verifyFormValidation = function() {
        // Switch to the password settings
        casper.click('a[href="#accountpreferences-password"]', 'Switch to password tab');
        // Try submitting the form without putting in any values
        casper.fill('form#accountpreferences-password', {
            'accountpreferences-current-password': '',
            'accountpreferences-new-password': '',
            'accountpreferences-retype-password': ''
        }, false);
        // Submit the form
        casper.click('form#accountpreferences-password button[type="submit"]', 'Submit the form');
        // Wait for a notification to show and verify it is an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertExists('#oae-notification-container .alert.alert-error', 'Password form successfully validated empty form');
        });

        // Try submitting the form with incorrect current password
        casper.fill('form#accountpreferences-password', {
            'accountpreferences-current-password': 'incorrectpassword',
            'accountpreferences-new-password': 'testtest',
            'accountpreferences-retype-password': 'testtest'
        }, false);
        // Submit the form
        casper.click('form#accountpreferences-password button[type="submit"]', 'Submit the form');
        // Wait for a notification to show and verify it is an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertExists('#oae-notification-container .alert.alert-error', 'Password form successfully validated incorrect current password');
        });

        // Try submitting the form with non matching new password
        casper.fill('form#accountpreferences-password', {
            'accountpreferences-current-password': 'testtest',
            'accountpreferences-new-password': 'nonmatching',
            'accountpreferences-retype-password': 'password'
        }, false);
        // Submit the form
        casper.click('form#accountpreferences-password button[type="submit"]', 'Submit the form');
        // Wait for a notification to show and verify it is an error
        casper.waitForSelector('#oae-notification-container .alert', function() {
            test.assertExists('#oae-notification-container .alert.alert-error', 'Password form successfully validated non-matching retyped password');
        });
    };

    /**
     * Starts the browser and points it to the landing page.
     * Will create a user to test account preferences with
     */
    casper.start(configUtil().tenantUI, function() {
        // Create a user to test accountpreferences with
        var user = null;
        userUtil().createUsers(1, function(users) {
            user = users[0];
        });

        // Login with that user
        casper.then(function() {
            userUtil().doLogIn(user.username, configUtil().defaultUserPassword);
        });

        // Open the accountpreferences modal
        casper.then(function() {
            casper.echo('Verify open account preferences modal', 'INFO');
            verifyOpenAccountPreferences();
        });

        // Test 1: Verify changing timezone and language
        casper.then(function() {
            casper.echo('Verify changing timezone and language', 'INFO');
            casper.then(function() {
                verifyChangeTimezoneAndLanguage();
            });
        });

        // Test 2: Verify changing password
        casper.then(function() {
            casper.echo('Verify changing password', 'INFO');
            casper.then(function() {
                openAccountPreferences();
            });
            casper.then(function() {
                verifyChangePassword();
            });
            userUtil().doLogOut();
            userUtil().doLogIn(user.username, 'testtest');
        });

        // Test 3: Verify form validation
        casper.waitForSelector('#me-clip-container .oae-trigger-accountpreferences', function() {
            casper.echo('Verify form validation', 'INFO');
            casper.then(function() {
                openAccountPreferences();
            });
            casper.then(function() {
                verifyFormValidation();
            });
        });

        // Log out at the end of the test
        casper.then(function() {
            userUtil().doLogOut();
        });
    });

    casper.run(function() {
        test.done();
    });
});
