/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid, showSettings) {

        // The widget container
        $rootel = $('#' + uid);

        /**
         * Resets the widget to its original state when the modal is closed
         */
        var reset = function() {
            // Reset all the forms
            $('form', $rootel).each(function(i, form) {
                // Reset the form
                $(form)[0].reset();
                // Clear the validation messages from the form
                oae.api.util.validation().clear(form);
            });

            // Show the first tab
            $('#accountpreferences-tab-container ul li:first-child a').click();
        };

        /**
         * Changes the password of the currently authenticated user
         *
         * @return {Boolean}       Returns false to avoid native form submission
         */
        var changePassword = function() {
            var oldPassword = $('#accountpreferences-current-password', $rootel).val();
            var newPassword = $('#accountpreferences-new-password', $rootel).val();

            oae.api.authentication.changePassword(oldPassword, newPassword, function(err) {
                if (err) {
                    if (err.code === 400) {
                        // The user has a non-local account
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'accountpreferences'),
                            oae.api.i18n.translate('__MSG__YOUR_PASSWORD_CANNOT_BE_CHANGED_HERE__', 'accountpreferences'),
                            'error'
                        );
                    } else if (err.code === 401) {
                        // Show a 'wrong current password' failure
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'accountpreferences'),
                            oae.api.i18n.translate('__MSG__THE_PROVIDED_PASSWORD_IS_INCORRECT__', 'accountpreferences'),
                            'error'
                        );
                    } else {
                        // Show a generic failure notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__PASSWORD_NOT_UPDATED__', 'accountpreferences'),
                            oae.api.i18n.translate('__MSG__PASSWORD_UPDATE_FAILED__', 'accountpreferences'),
                            'error'
                        );
                    }
                } else {
                    // Hide the modal after saving
                    $('#accountpreferences-modal', $rootel).modal('hide');

                    // Show a success notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__PASSWORD_UPDATED__', 'accountpreferences'),
                        oae.api.i18n.translate('__MSG__PASSWORD_SUCCESSFULLY_UPDATED__', 'accountpreferences')
                    );
                }
            });

            return false;
        };

        /**
         * Updates the account preferences for timezone and locale
         *
         * @return {Boolean}       Returns false to avoid native form submission
         */
        var updatePreferences = function() {
            var profile = {
                'locale': $('#accountpreferences-language', $rootel).val(),
                'timezone': $('#accountpreferences-timezone', $rootel).val()
            };

            oae.api.user.updateUser(profile, function(err) {
                if (err) {
                    // Show a failure notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__PREFERENCES_NOT_UPDATED__', 'accountpreferences'),
                        oae.api.i18n.translate('__MSG__PREFERENCES_UPDATE_FAILED__', 'accountpreferences'),
                        'error'
                    );
                } else {
                    // Hide the modal after saving
                    $('#accountpreferences-modal', $rootel).modal('hide');

                    // Show a success notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__PREFERENCES_UPDATED__', 'accountpreferences'),
                        oae.api.i18n.translate('__MSG__PREFERENCES_SUCCESSFULLY_UPDATED__', 'accountpreferences')
                    );

                    // Reload the page after 2 seconds to apply the timezone and language changes
                    setTimeout(function() {
                        document.location.reload();
                    }, 2000);
                }
            });

            return false;
        };

        /**
         * Set up validation for every account preferences form. This will validate and submit the forms or
         * show an error message when appropriate.
         */
        setUpValidation = function() {
            // Validate the password form
            oae.api.util.validation().validate($('#accountpreferences-password', $rootel), {
                'rules': {
                    'accountpreferences-new-password': {
                        'minlength': 6
                    },
                    'accountpreferences-retype-password': {
                        'equalTo': '#accountpreferences-new-password'
                    }
                },
                'messages': {
                    'accountpreferences-new-password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__'),
                        'minlength': oae.api.i18n.translate('__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__')
                    },
                    'accountpreferences-retype-password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_REPEAT_YOUR_PASSWORD__'),
                        'passwordmatch': oae.api.i18n.translate('__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__')
                    }
                },
                'submitHandler': changePassword
            });

            // Validate the preferences form
            oae.api.util.validation().validate($('#accountpreferences-preferences', $rootel), {
                'submitHandler': updatePreferences
            });
        };

        /**
         * Sort timezone objects based on their offset. Timezones with the same offset will
         * be sorted alphabetically based on display name
         *
         * @see Array#sort
         */
        var sortTimezones = function(a, b) {
            if (a.offset === b.offset) {
                if (a.displayName > b.displayName) {
                    return 1;
                } else {
                    return -1;
                }
            } else {
                return a.offset - b.offset;
            }
        };

        /**
         * Process the timezones object into an array that is sorted by offset. A `GMT+HH:mm` or `GMT-HH:mm`
         * string is also added onto the final sorted timezones array.
         *
         * @param  {Object}         timezones           Timezones object containing the available timezones and their offset
         * @return [Object[]]                           Array of timezones sorted by offset
         */
        var processTimezones = function(timezones) {
            var convertedTimezones = [];
            // Convert the timezones object to a proper array
            $.each(timezones, function(timezoneId, timezone) {
                timezone.id = timezoneId;
                // The timezone offset received in the feed needs to be inverted
                timezone.offset = -1 * timezone.offset;

                // We convert the offset into an `HH:mm` string and therefore calculate
                // the hours and minutes based on the offset. We first make sure that
                // we are working with a positive offset
                var absOffset = Math.abs(timezone.offset);
                var offsetHours = Math.floor(absOffset);
                var offsetMinutes = (absOffset % 1) * 60;
                // Create a new date with the calculated hours and minutes and run
                // through Globalize to convert it into a formatted `HH:mm` string
                var offsetTime = Globalize.format(new Date(0, 0, 0, offsetHours, offsetMinutes), 'HH:mm');

                // Construct the final offset string in the form of `GMT+HH:mm` or `GMT-HH:mm`
                if (timezone.offset >= 0) {
                    timezone.offsetString = 'GMT+' + offsetTime;
                } else {
                    timezone.offsetString = 'GMT-' + offsetTime;
                }
                convertedTimezones.push(timezone);
            });

            // Sort the timezones array based on their offset.
            convertedTimezones.sort(sortTimezones);
            return convertedTimezones;
        };

        /**
         * Render the list of available languages and timezones and select the user's current timezone and
         * locale in the dropdowns. The i18n debug language will only be shown to administrators.
         */
        var setUpPreferences = function() {
            // Render the available languages
            oae.api.util.template().render($('#accountpreferences-language-template', $rootel), null, $('#accountpreferences-language', $rootel));
            // Fetch and render the available timezones
            $.ajax({
                'url': '/api/timezones',
                'success': function(timezones) {
                    timezones = processTimezones(timezones);
                    oae.api.util.template().render($('#accountpreferences-timezone-template', $rootel), {
                        'timezones': timezones
                    }, $('#accountpreferences-timezone', $rootel));

                    // Select the current user's language and timezone
                    $('#accountpreferences-language', $rootel).val(oae.data.me.locale.locale);
                    $('#accountpreferences-timezone', $rootel).val(oae.data.me.timezone);
                }
            });
        };

        /**
         * Sets up the accountpreferences modal
         */
        var setUpAccountPreferencesModal = function() {
            $(document).on('click', '.oae-trigger-accountpreferences', function() {
                $('#accountpreferences-modal', $rootel).modal({
                    'backdrop': 'static'
                });
                setUpPreferences();
                setUpValidation();
            });

            $('#accountpreferences-modal', $rootel).on('hidden', reset);
        };

        setUpAccountPreferencesModal();

    };
});
