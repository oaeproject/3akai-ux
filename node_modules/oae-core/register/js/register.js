/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core', 'markdown'], function($, _, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        // Allow use of <span> elements as buttons
        oae.api.util.enableFakeButtonsUnder($rootel);

        // Check whether or not the register form should show a recaptcha challenge
        var recaptchaEnabled = oae.api.config.getValue('oae-principals', 'recaptcha', 'enabled');

        // Check whether or not the Terms and Conditions should be accepted
        var termsAndConditionsEnabled = oae.api.config.getValue('oae-principals', 'termsAndConditions', 'enabled');

        /**
         * Set up a reCaptcha container that will used to verify
         * that the current user is a real human
         */
        var setUpReCaptcha = function() {
            if (recaptchaEnabled) {
                // Only require the recaptcha library when recaptcha has been enabled
                require(['//www.google.com/recaptcha/api/js/recaptcha_ajax.js'], function() {
                    var captchaContainer = $('#register-captcha-container', $rootel)[0];
                    Recaptcha.create(oae.api.config.getValue('oae-principals', 'recaptcha', 'publicKey'), captchaContainer, {theme: 'custom'});
                });
            } else {
                $('#register-captcha', $rootel).hide();
            }
        };

        /**
         * Show a validation message for reCaptcha
         */
        var showRecaptchaError = function() {
            // Set the aria attributes on the main recaptcha input field
            $('#recaptcha_response_field', $rootel).attr({
                'aria-invalid': 'true',
                'aria-describedby': 'register-captcha-error'
            });
            $('#register-captcha', $rootel).addClass('has-error');
            $('#register-captcha-error', $rootel).show();
        };

        /**
         * Hide the reCaptcha validation message
         */
        var hideRecaptchaError = function() {
            // Remove the aria attributes on the main recaptcha input field
            $('#recaptcha-response-field', $rootel).removeAttr('aria-invalid aria-describedby');
            $('#register-captcha-error', $rootel).hide();
            $('#register-captcha', $rootel).removeClass('has-error');
        };

        /**
         * Verify whether or not the entered username already exists as a login id on the
         * current tenant.
         *
         * @param  {String}     username                The username we want to check the existence of
         * @param  {Function}   [callback]              Standard callback function.
         * @param  {Boolean}    [callback.available]    Whether or not the username is available
         * @return {Boolean}                            When no callback is provided, this function will be synchronous and will return whether or not the username is available
         */
        var isUserNameAvailable = function(username, callback) {
            // We check if the userid is still available on the current tenant.
            // We expect a 200 if it already exists and a 404 if it doesn't exist yet.
            var available = false;
            $.ajax({
                url: '/api/auth/exists/' + username,
                async: false,
                success: function() {
                    // The username already exists
                    if (callback) {
                        callback(false);
                    }
                },
                error: function(xhr, textStatus, thrownError) {
                    // The username is still available
                    if (callback) {
                        callback(true);
                    } else {
                        available = true;
                    }
                }
            });
            return available;
        };

        /**
         * Set up the validation on the register form, including the error messages
         */
        var setUpValidation = function() {
            var validateOpts = {
                'rules': {
                    'username': {
                        'minlength': 3,
                        'nospaces': true,
                        'validchars': true,
                        'usernameavailable': true
                    },
                    'password': {
                        'minlength': 6
                    },
                    'password_repeat': {
                        'equalTo': '#register-password'
                    }
                },
                'messages': {
                    'firstName': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_FIRST_NAME__', 'register')
                    },
                    'lastName': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_LAST_NAME__', 'register')
                    },
                    'email': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_VALID_EMAIL_ADDRESS__', 'register'),
                        'email': oae.api.i18n.translate('__MSG__THIS_IS_AN_INVALID_EMAIL_ADDRESS__', 'register')
                    },
                    'username': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_USERNAME__'),
                        'minlength': oae.api.i18n.translate('__MSG__THE_USERNAME_SHOULD_BE_AT_LEAST_THREE_CHARACTERS_LONG__', 'register'),
                        'nospaces': oae.api.i18n.translate('__MSG__THE_USERNAME_SHOULDNT_CONTAIN_SPACES__', 'register')
                    },
                    'password': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_YOUR_PASSWORD__'),
                        'minlength': oae.api.i18n.translate('__MSG__YOUR_PASSWORD_SHOULD_BE_AT_LEAST_SIX_CHARACTERS_LONG__')
                    },
                    'password_repeat': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_REPEAT_YOUR_PASSWORD__'),
                        'passwordmatch': oae.api.i18n.translate('__MSG__THIS_PASSWORD_DOES_NOT_MATCH_THE_FIRST_ONE__')
                    },
                    'termsandconditions': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ACCEPT_THE_TERMS_AND_CONDITIONS__', 'register')
                    }
                },
                'methods': {
                    'validchars': {
                        'method': function(value, element) {
                            return this.optional(element) || !(/[<>\\\/{}\[\]!@#\$%\^&\*,:]+/i.test(value));
                        },
                        'text': oae.api.i18n.translate('__MSG__CREATE_ACCOUNT_INVALIDCHAR__', 'register')
                    },
                    'usernameavailable': {
                        'method': function(value, element) {
                            var response = false;
                            isUserNameAvailable(value, function(available) {
                                response = available;
                                // Show the available icon if the username is available, otherwise show the unavailable icon
                                if (available) {
                                    $('#register-username-available', $rootel).removeClass('icon-remove').addClass('icon-ok');
                                } else {
                                    $('#register-username-available', $rootel).removeClass('icon-ok').addClass('icon-remove');
                                }
                            });
                            return response;
                        },
                        'text': oae.api.i18n.translate('__MSG__THIS_USERNAME_HAS_ALREADY_BEEN_TAKEN__', 'register')
                    }
                },
                'submitHandler': createUser
            };
            oae.api.util.validation().validate($('#register-form', $rootel), validateOpts);
        };

        /**
         * Create the new user. This will be called after validation has succeeded
         */
        var createUser = function() {
            // Hide the recaptcha validation
            hideRecaptchaError();

            // Get the form values
            var values = $('#register-form').serializeObject();
            // Collect the recaptcha values
            if (recaptchaEnabled) {
                values['recaptchaChallenge'] = Recaptcha.get_challenge();
                values['recaptchaResponse'] = Recaptcha.get_response();
            }

            // Disable the register button during creation, so it can't be clicked multiple times
            $('button, input', $rootel).prop('disabled', true);

            // Create the user
            var displayName = values.firstName + ' ' + values.lastName;
            var additionalOptions = {
                'email': values.email
            };

            oae.api.user.createUser(values.username, values.password, displayName, additionalOptions, values.recaptchaChallenge, values.recaptchaResponse, function(err, createdUser) {
                if (err) {
                    if (recaptchaEnabled) {
                        // Refresh reCaptcha
                        Recaptcha.reload();
                        // The user entered an invalid reCaptcha token
                        if (err.msg === 'Invalid reCaptcha token') {
                            showRecaptchaError();
                        }
                    }
                    // Unlock the register button
                    $('button, input', $rootel).prop('disabled', false);
                } else {
                    oae.api.authentication.localLogin(values.username, values.password, function() {
                        // Relocate to the user home space
                        window.location = '/me';
                    });
                }
            });
        };

        /**
         * Show the register form and hide the Terms and Conditions
         */
        var showRegisterForm = function() {
            $('#register-form', $rootel).show();
            $('#register-terms-and-conditions-container', $rootel).hide();
            $('.modal-footer', $rootel).hide();
        };

        /**
         * Hide the register form and show the Terms and Conditions
         */
        var showTermsAndConditions = function() {
            $('#register-form', $rootel).hide();
            $('#register-terms-and-conditions-container', $rootel).show();
            $('.modal-footer', $rootel).show();
        };

        /**
         * Initialize the Terms and Conditions view
         */
        var setUpTermsAndConditions = function() {
            $('#register-accept-terms-button', $rootel).show();

            // Bind the Terms and Conditions button
            $rootel.on('click', '#register-terms-and-conditions', function() {
                // Show the Terms and Conditions
                if ($('#register-terms-and-conditions-container', $rootel).is(':empty')) {
                    oae.api.user.getTC(function(err, data) {
                        oae.api.util.template().render($('#register-termsandconditions-template', $rootel), {
                            'terms': data.text
                        }, $('#register-terms-and-conditions-container', $rootel));
                    });
                }

                // Hide the register form and show the Terms and Conditions
                showTermsAndConditions();
            });

            // Bind the `back` button
            $rootel.on('click', '#register-continue-signup', function() {
                // Show the register form and hide the Terms and Conditions
                showRegisterForm();
            });
        };

        /**
         * Initialize the register modal dialog
         */
        var initRegister = function() {
            $(document).on('click', '.oae-trigger-register', function() {
                // Show the register form and hide the Terms and Conditions
                showRegisterForm();

                // Trigger the modal dialog
                $('#register-modal', $rootel).modal({
                    'backdrop': 'static'
                });
                $('#register-modal', $rootel).on('shown.bs.modal', function () {
                    // Set focus to the group name field
                    $('#register-firstname', $rootel).focus();
                });
            });
        };

        initRegister();
        setUpReCaptcha();
        setUpValidation();
        // Only show and bind Terms and Conditions if the tenant requires them to be accepted
        if (termsAndConditionsEnabled) {
            setUpTermsAndConditions();
        }

    };
});
