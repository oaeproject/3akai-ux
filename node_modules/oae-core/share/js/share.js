/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    return function(uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // Variable that will keep track of the element that triggered the clickover
        var $trigger = null;

        // Variable that will keep track of the current page context.
        // This can be a content item or a discussion item.
        var contextProfile = null;

        // Variables that will keep track of the resourceType of the resource(s) being shared (i.e. `content`, `discussion`)
        var resourceType = null;

        // Variable that will keep track of the resources to share. For each resource, the `id` and `resourceSubType` will be stored
        var selectedResources = null;

        /**
         * Toggle the share clickover
         */
        var toggleShareClickover = function() {
            // Emulate a click on the clickover trigger
            $trigger.click();
        };

        /**
         * Share the selected resources with the selected users and groups. When the sharing has completed,
         * the clickover will close.
         */
        var setUpShare = function() {
            $(document).on('click', '#share-save', function() {
                // Disable the share button
                $('#share-save', $rootel).prop('disabled', true);

                // Extract the resource ids and principal ids
                var resources = _.pluck(selectedResources, 'id');
                var principals = _.pluck(oae.api.util.autoSuggest().getSelection($rootel), 'id');
                // A different API function needs to be used, depending on whether we're sharing a
                // discussion or a content item
                var shareFunction = null;
                if (resourceType === 'content') {
                    shareFunction = oae.api.content.shareContent;
                } else if (resourceType === 'discussion') {
                    shareFunction = oae.api.discussion.shareDiscussion;
                }

                var done = 0;
                var share = function() {
                    shareFunction(resources[done], principals, function(err) {
                        done++;
                        if (done === resources.length) {
                            /*!
                             * TODO: The share action will return an error every time all of the selected
                             * principals have the content/discussion already in their library. Because this
                             * isn't actually a failure and there are many permutations, we need to come up
                             * with a good way of tracking the successes/errors. Currently, we only show an
                             * error message when the current user is not allowed to share.
                             */
                            var data = {
                                'count': resources.length,
                                'err': err && err.code === 401,
                                'mylibrary': _.indexOf(principals, oae.data.me.id) !== -1,
                                'resourceType': resourceType,
                                'resourceSubType': selectedResources[0].resourceSubType
                            };

                            var notificationTitle = oae.api.util.template().render($('#share-notification-title-template', $rootel), data);
                            var notificationBody = oae.api.util.template().render($('#share-notification-body-template', $rootel), data);
                            oae.api.util.notification(notificationTitle, notificationBody, data.err ? 'error': 'success');

                            // Deselect all items in the list
                            $(document).trigger('oae.list.deselectall');

                            // Hide the clickover
                            toggleShareClickover();
                        } else {
                            share();
                        }
                    });
                };
                share();
            });
        };

        /**
         * Disable/enable the share button when an item has been added/removed from the autosuggest field.
         */
        var autoSuggestChanged = function() {
            $('#share-save', $rootel).prop('disabled', oae.api.util.autoSuggest().getSelection($rootel).length ? false : true);
        };

        /**
         * Initializes the autosuggest field used to select the people and groups to share with
         */
        var setUpAutoSuggest = function() {
            var ghosts = [];

            // We offer `My Library` or `My Discssions` as a ghost item, unless the user is
            // looking at his personal content/discussion library
            if (!contextProfile || contextProfile.id !== oae.data.me.id) {
                // If a content item is being shared, we add `My Library` as the ghost option
                if (resourceType === 'content') {
                    ghosts.push({
                        'id': oae.data.me.id,
                        'displayName': oae.api.i18n.translate('__MSG__MY_LIBRARY__')
                    });
                // If a discussion is being shared, we add `My Discussions` as the ghost option
                } else if (resourceType === 'discussion') {
                    ghosts.push({
                        'id': oae.data.me.id,
                        'displayName': oae.api.i18n.translate('__MSG__MY_DISCUSSIONS__')
                    });
                }
            }

            // Initialize the autoSuggest field
            oae.api.util.autoSuggest().setup($('#share-autosuggest', $rootel), {
                'ghosts': ghosts,
                'selectionChanged': autoSuggestChanged,
                'url': '/api/search/interact'
            }, null, function() {
                // Focus on the autosuggest field once it has been set up
                oae.api.util.autoSuggest().focus($rootel);
            });
        };

        /**
         * Determine whether or not the share widget is triggered for an individual element or for
         * a number of selected items in a list. In case it has been trigger by an individual resource,
         * we expect to find a `data-id` attribute on the element, as well as a `data-resouceSubType`
         * attribute for the various content types. If the `data-id` attribute cannot be found, we assume
         * that the selected items from a list are being shared
         */
        var getContext = function() {
            // The resourceType data attribute should be available on all share triggers
            // and will tell us what type of resource is being shared (i.e., content, discussion)
            resourceType = $trigger.attr('data-resourceType');
            // If an individual item is shared, we expect to find the data-id attribute
            if ($trigger.attr('data-id')) {
                selectedResources = [{
                    'id': $trigger.attr('data-id'),
                    'resourceSubType': $trigger.attr('data-resourceSubType')
                }];
                setUpAutoSuggest();
            // If the selected items in a list are being shared, we first request the current page context.
            // If the current page context is the current user's personal library, we don't offer 'My Library'
            // as a ghost item, otherwise we always do. After that, we request the selected items from the current list
            } else {
                // Get the page context
                $(document).on('oae.context.send.share', function(ev, data) {
                    contextProfile = data;

                    // Get the list selection
                    $(document).on('oae.list.sendSelection.share', function(ev, data) {
                        selectedResources = data.results;
                        setUpAutoSuggest();
                    });
                    $(document).trigger('oae.list.getSelection', 'share');
                });
                $(document).trigger('oae.context.get', 'share');
            }
        };

        /**
         * Initializes the share clickover
         */
        var setUpShareClickover = function() {
            $(document).on('click', '.oae-trigger-share', function() {
                $trigger = $(this);
                // Trigger the share clickover
                oae.api.util.clickover($trigger, $('.share-widget'), {
                    'onShown': function($currentRootEl) {
                        $rootel = $currentRootEl;
                        getContext();
                    }
                });
            });

            // Close the clickover when the cancel button is clicked
            $(document).on('click', '#share-cancel', toggleShareClickover);
        };

        setUpShare();
        setUpShareClickover();

    };
});
