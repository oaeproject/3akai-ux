/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core', 'jquery.fileupload', 'jquery.iframe-transport'], function($, _, oae) {

    return function(uid, showSettings) {

        ////////////////////
        // Initialization //
        ////////////////////

        // Initialize the modal dialog
        var modalContainer = oae.api.util.modal($('#addcontent_container'));

        /**
         * Initialize the add content overlay. We show the modal container,
         * and fill out the user's group memberships in the target libraries
         */
        var initAddContent = function() {
            // Show the modal dialog every time the trigger is clicked
            $(document).on('click', '.oae-trigger-addcontent', function() {
                modalContainer.open();
            });
        };

        ////////////////////
        // Left hand menu //
        ////////////////////

        /**
         * Make the left hand items clickable, so the user can switch between the form for
         * uploading a file, creating a document and adding a link
         */
        var setUpLeftMenu = function() {
            $(document).on('click', '.addcontent-container-lhchoice-item', function() {
                // Give the clicked element the selected style
                $('.addcontent-container-lhchoice-item').removeClass('addcontent-container-lhchoice-selected-item');
                $(this).addClass('addcontent-container-lhchoice-selected-item');
                // Show the correct container
                $('.addcontent-newitem-container').hide();
                $('#' + $(this).attr('id') + '_container').show();
                return false;
            });
        };

        /////////////////
        // Render list //
        /////////////////

        // Variable that keeps track of the content items that are queued for adding
        var contentToAdd = [];

        /**
         * Render the list of items that are queued to be added to the system
         */
        var renderList = function() {
            oae.api.util.renderTemplate($('#addcontent_container_selecteditems_template'), {'items': contentToAdd}, $('#addcontent_container_selecteditems_list'));
            // Enable the Done, add collected button
            if (contentToAdd.length > 0) {
                $('#addcontent_done_add_collected').removeAttr('disabled');
            } else {
                $('#addcontent_done_add_collected').attr('disabled', 'disabled');
            }
        };

        /////////////////
        // Add to list //
        /////////////////

        // Variable that keeps track of the currently selected file in the file upload form
        var selectedFile = null;

        /**
         * Set up the validation for the add content form. This will be a single form containing upload file,
         * create document and add link, but only one of them will be visible at a time, which is the part
         * of the form that will be validated.
         */
        var setUpValidation = function() {
            var validateOpts = {
                'insertAfterLabel': true,
                'methods': {
                    'fileselected': {
                        'method': function(value, element) {
                            return selectedFile !== null;
                        }
                    }
                },
                'messages': {
                    'addcontent_upload_content_title': {
                        'required': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_FILENAME__', 'addcontent'),
                        'fileselected': oae.api.i18n.translate('__MSG__PLEASE_SELECT_A_FILE_TO_UPLOAD__', 'addcontent')
                    },
                    'addcontent_add_document_title': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_DOCUMENT_TITLE__', 'addcontent'),
                    'addcontent_add_link_url': oae.api.i18n.translate('__MSG__PLEASE_ENTER_A_VALID_URL__', 'addcontent')
                },
                'submitHandler': addContentToList
            };
            oae.api.util.validation().validate($('#addcontent_upload_content_form'), validateOpts);
        };

        /**
         * Set up the file upload field using the jQuery.fileupload plugin (/api/content/c:cambridge:Tevlic8NiJ/download). This will
         * also set up the dragging and dropping of content items
         */
        var setUpFileUpload = function() {
            // File upload options as specified by jQuery fileupload (https://github.com/blueimp/jQuery-File-Upload/wiki/Options)
            var fileuploadOptions = {
                'url': '/api/content/create',
                'dropZone': $('#addcontent_container_selecteditems'),
                'drop': function(ev, data) {
                    ev.preventDefault();
                    $.each(data.files, function(index, file) {
                        // Only add actual files. When dropping a folder, they will have
                        // a size of 0
                        if (file.size > 0) {
                            var contentObj = {
                                'displayName': file.name,
                                'visibility': $('#addcontent_upload_content_permissions').val(),
                                'file': file,
                                'type': 'file'
                            };
                            // Add the item to the queue
                            contentToAdd.push(contentObj);
                        }
                    });
                    // Re-render the list
                    renderList();
                },
                'add': function(e, data) {
                    selectedFile = data.files[0];
                    // IE returns the full path instead of just the filename, so we take off the path
                    var fileName = selectedFile.name.split('\\').pop();
                    $('#addcontent_upload_content_title').val(fileName);
                    $('#addcontent_upload_content_title').select();
                }
            };
            $('#addcontent_file_upload').fileupload(fileuploadOptions);
        };

        /**
         * Select the right default value for content visibility for each of the different content types, based on 
         * the configuration options set in the admin UI
         */
        var setUpDefaultValues = function() {
            $('#addcontent_upload_content_permissions').val(oae.api.config.getValue('oae-content', 'visibility', 'files'));
            $('#addcontent_add_document_permissions').val(oae.api.config.getValue('oae-content', 'visibility', 'sakaidocs'));
            $('#addcontent_add_link_permissions').val(oae.api.config.getValue('oae-content', 'visibility', 'links'));
        };

        /**
         * When the add form validation has succeeded, this function will add the added items into the right hand
         * `Collected items` panel
         */
        var addContentToList = function() {
            var contentObj = null;
            // Uploading a file
            if ($('#addcontent_upload_content_container').is(':visible')) {
                contentObj = {
                    'displayName': $('#addcontent_upload_content_title').val(),
                    'description': $('#addcontent_upload_content_description').val(),
                    'visibility': $('#addcontent_upload_content_permissions').val(),
                    'file': selectedFile,
                    'type': 'file'
                };
            // Adding a document
            } else if ($('#addcontent_add_document_container').is(':visible')) {
                contentObj = {
                    'displayName': $('#addcontent_add_document_title').val(),
                    'description': $('#addcontent_add_document_description').val(),
                    'visibility': $('#addcontent_add_document_permissions').val(),
                    'type': 'sakaidoc'
                };
            // Adding a link
            } else if ($('#addcontent_add_link_container').is(':visible')) {
                contentObj = {
                    'link': $('#addcontent_add_link_url').val(),
                    'displayName': $('#addcontent_add_link_title').val() || $('#addcontent_add_link_url').val(),
                    'description': $('#addcontent_add_link_description').val(),
                    'visibility': $('#addcontent_add_link_permissions').val(),
                    'type': 'link'
                };
            }
            // Add the item to the queue
            contentToAdd.push(contentObj);
            // Clear the form
            resetForm();
            // Re-render the list
            renderList();
        };

        /**
         * Reset the add content form by clearing all of the values as well as clearing the
         * currently selected file from the user's hard disk
         */
        var resetForm = function() {
            // Clear the form
            $('#addcontent_upload_content_form')[0].reset();
            // Clear the currently selected file
            selectedFile = null;
        }

        //////////////////////
        // Remove from list //
        //////////////////////

        /**
         * Remove an item from the list of content that needs to be added
         */
        var setUpRemove = function() {
            $(document).on('click', '.addcontent-selecteditems-remove', function() {
                // Remove the element from the list
                var index = $(this).parent().index();
                contentToAdd.splice(index, 1);
                renderList();
                return false;
            });
        };

        /////////////////
        // Memberships //
        /////////////////

        /**
         * Fill the 'Save all to' dropdown with all of the current user's
         * group memberships
         */
        var initMemberships = function() {
            oae.api.group.memberOf(null, null, null, function(err, memberships) {
                oae.api.util.renderTemplate($('#addcontent_saveto_template'), memberships, $('#addcontent_saveto'));
            });
        };

        ///////////////////////////
        // Add content to system //
        ///////////////////////////

        // Variable that will be used to cache the progress indicator shown whilst
        // a group is being created
        var progressIndicator = null;

        /**
         * When the `Done, add collected` button is clicked, we add all of the collected
         * items to the system
         */
        var setUpAddContent = function() {
            $(document).on('click', '#addcontent_done_add_collected', function() {
                // Show progress indicator
                if (!progressIndicator) {
                    var title = oae.api.i18n.translate('__MSG__UPLOADING_YOUR_CONTENT__');
                    var description = oae.api.i18n.translate('__MSG__PROCESSING_UPLOAD__');
                    progressIndicator = oae.api.util.progressIndicator(title, description);
                }
                progressIndicator.show();

                // Add to the selected library
                var libraryToAdd = $('#addcontent_saveto').val();

                // Callback function that will be called every time a content
                // item has been added.
                var done = 0;
                var finishedAdd = function(err, contentObj) {
                    done++;
                    if (done === contentToAdd.length) {
                        // Close the modal dialog and the progress indicator
                        progressIndicator.hide();
                        modalContainer.close();

                        // Show a notification message
                        var notificationText = oae.api.util.renderTemplate($('#addcontent_notification_finished_template'), {
                            librarytitle: $('#addcontent_saveto option:selected').text()
                        });
                        oae.api.util.showNotification(oae.api.i18n.translate('__MSG__LIBRARY__'), notificationText);

                        // Reset the list
                        contentToAdd = [];
                        $('#addcontent_upload_content_form')[0].reset();
                        renderList();

                        // Trigger an event so other widgets can reload themselves if necessary
                        $(window).trigger('done.addcontent.oae');
                    }
                };

                // Upload all of the collected files in parallel
                $.each(contentToAdd, function(index, item) {
                    if (item.type === 'file') {
                        oae.api.content.createFile(item.displayName, item.description, item.visibility, $('#addcontent_file_upload'), item.file, [], [libraryToAdd], finishedAdd);
                    } else if (item.type === 'link') {
                        oae.api.content.createLink(item.displayName, item.description, item.visibility, item.link, [], [libraryToAdd], finishedAdd);
                    } else if (item.type === 'sakaidoc') {
                        oae.api.content.createSakaiDoc(item.displayName, item.description, item.visibility, [], [libraryToAdd], finishedAdd);
                    }
                });
            });
        };

        /**
         * Add ability to edit the details of a content item already in the queue.
         */
        var setUpEditDetails = function() {

            $(document).on('click', '.addcontent-selecteditems-actions-edit', function() {
                var index = $(this).parents('li').index();
                var position = $(this).parents('li').position();

                oae.api.util.renderTemplate(addcontent_selecteditems_edit_data_template,{
                    'item': contentToAdd[index],
                    'index': index
                }, $('#addcontent_selecteditems_edit_data_container'));

                $('#addcontent_selecteditems_edit_data_container').css({
                    'top': position.top + $(this).parents('li').height() + 10,
                    'left': position.left - 1
                });

                $('#addcontent_selecteditems_edit_data_container').show();

                var validateOpts = {
                    'insertAfterLabel': true,
                    'submitHandler': editContentDetails
                };

                oae.api.util.validation().validate($('#addcontent_selecteditems_edit_data_form'), validateOpts);
            });

            /**
             * Opens a popover with input fields allowing the user to change the details of a content item that's already in the queue.
             * @param {Object}   form   The submitted form DOM element
             */
            var editContentDetails = function(form) {
                var index = parseInt($(form).attr('data-contentindex'), 10);
                contentToAdd[index].displayName = $('#addcontent_selecteditems_edit_data_title').val();
                contentToAdd[index].description = $('#addcontent_selecteditems_edit_data_description').val();
                contentToAdd[index].visibility = $('#addcontent_selecteditems_edit_permissions_permissions').val();
                $('#addcontent_selecteditems_edit_data_container').hide();
                renderList();
                return false;
            };

            $(document).on('click', '.addcontent-selecteditems-edit-data-close', function() {
                $('#addcontent_selecteditems_edit_data_container').hide();
            });
        };

        initAddContent();
        setUpLeftMenu();
        setUpValidation();
        setUpFileUpload();
        setUpDefaultValues();
        setUpRemove();
        setUpEditDetails();
        initMemberships();
        setUpAddContent();
        renderList();

    };
});
