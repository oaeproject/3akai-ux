/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'jquery.oembed'], function($, oae) {

    return function(uid, showSettings, widgetData) {

        // Cache the widget container
        var $rootel = $('#' + uid);

        var maxHeight = 500;
	    var maxWidth = 800;

        // Function to update providers with custom handling
        var updateProviders = function() {
            $.fn.updateOEmbedProvider('dribbble', null, null, null, {
                templateRegex:/.*shots\/([\d]+).*/,
                templateData : function(data) {
                    if (!data.image_url) {
                        return false;
                    }
                    return  '<img src="'+data.image_url+'"/>';
                }
            });
            $.fn.updateOEmbedProvider('twitgoo.com', 'photo', ['twitgoo\\.com/.+'],'http://twitgoo.com/show/img/$1', {
                templateRegex: /.*com\/([^\/]+).*/,
                embedtag: {tag:'img'},
                nocache:1
            });

            $.fn.updateOEmbedProvider('img.ly', 'photo', ['img\\.ly/.+'],'http://img.ly/show/large/$1', {
                templateRegex: /.*ly\/([^\/]+).*/,
                embedtag: {tag: 'img'},
                nocache: 1
            });

            $.fn.updateOEmbedProvider('imgur.com', 'photo', ['imgur\\.com/gallery/.+'],'http://i.imgur.com/$1.jpg', {
                templateRegex: /.*gallery\/([^\/]+).*/,
                embedtag: {tag: 'img'},
                nocache:1
            });

            $.fn.updateOEmbedProvider('twitvid', 'video', ['telly\\.com/.+'],'http://www.telly.com/embed.php?guid=$1&autoplay=0', {
                templateRegex: /.*telly\.com\/(\w+).*/,
                embedtag: {tag: 'iframe', width: 800, height: 500 }
            });

            $.fn.updateOEmbedProvider('scribd', 'rich', ['scribd\\.com/.+'],'http://www.scribd.com/embeds/$1/content?start_page=1&view_mode=list', {
                templateRegex: /.*doc\/([^\/]+).*/,
                embedtag: {tag: 'iframe', width: 800, height: 500}
            });

            $.fn.updateOEmbedProvider('pastebin', 'rich', ['pastebin\\.com/[\\S]{8}'],'http://pastebin.com/embed_iframe.php?i=$1', {
                templateRegex: /.*\/(\S{8}).*/,
                embedtag: {tag: 'iframe', width: 800,height: 500, scrolling: 'yes'}
            });

            $.fn.updateOEmbedProvider('opengraph', null, null, null, {
                yql: {
                    xpath: '//meta|//title|//link',
                    from: 'html',
                    datareturn: function(results) {
                        var noImage = false;
                        var code = $('<p/>');

                        if (results['og:type'] === 'video.other' && results['keywords'].indexOf('TED') !== -1 && results['keywords'].indexOf('Talks') !== -1) {
                            var url = results['og:url'].replace('http://www.ted.com/talks/','');
                            var embed = $('<iframe src="http://embed.ted.com/talks/' + url + '" width="560" height="315" frameborder="0" scrolling="no" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>');
                            code.append(embed);
                            noImage = true;
                        }
                        if (results['og:site_name'] === 'Spotify') {
                            var url = results['og:url'];
                            var embed = $('<iframe src="https://embed.spotify.com/?uri=' + results['og:audio'] + '" width="400" height="100" frameborder="0" allowtransparency="true"></iframe>');
                            code.append(embed);
                            noImage = true;
                        }
                        if (results['og:video']) {
                            var embed = $('<embed src="' + results['og:video'] + '"/>');
                            embed
                                .attr('type', results['og:video:type'] || 'application/x-shockwave-flash')
                                .css('max-height', 'auto')
                                .css('max-width', 'auto');
                            if(results['og:video:width']) {
                                embed.attr('width', results['og:video:width']);
                            }
                            if(results['og:video:height']) {
                                embed.attr('height', results['og:video:height']);
                            }
                            code.append(embed);
                            noImage = true;
                        }
                        if (noImage === false && results['og:image']) {
                            if (results['og:site_name'] === 'TwitPic') {
                                results['og:image'] = results['og:image'].replace('thumb', 'large');
                            }
                            var img = $('<img src="' + results['og:image'] + '">');
                            img.css('max-height', 'auto').css('max-width', 'auto');
                            if (results['og:image:width']) {
                                img.attr('width', results['og:image:width']);
                            }
                            if (results['og:image:height']) {
                                img.attr('height', results['og:image:height']);
                            }
                            code.append(img);
                        }
                        return code;
                    }
                }
            });
        };

        /**
         * Hide the spinner on the page when the link is embedded
         */
        var hideSpinner = function() {
            $('#oembed-spinner', $rootel).hide();
        };

        /**
         * Initialize this empty widget
         */
        var init = function() {

            // Update providers with custom handling
            updateProviders();

            // Change the link of spotify
        	if(widgetData.link.indexOf('play.spotify.com/') >= -1) {
                widgetData.link = widgetData.link.replace('play.spotify.com/','open.spotify.com/');
            }

            // Render the template with widget data
            oae.api.util.template().render('#oembed-template', {'link': widgetData.link}, $('#oembed-container', $rootel));

            // Embed the link
        	$('#oembed-container', $rootel).oembed(widgetData.link, {
                // Delete the arrow to collapse the container
                includeHandle: false,
                // Place the content into the container instead of creating new div
                embedMethod: 'fill',
                // Function executed after the embedding is finisched
                afterEmbed: function() {
                    hideSpinner();
                    // Add event to the iframe when it's loaded
	                $('iframe', $rootel).load(function() {
                        hideSpinner();

                        // Code to change the height and width of the iframe so it's maximum 800 width and
	                    var width = parseInt($('iframe', $rootel).attr('width'),10) || maxWidth;
	                    var height = parseInt($('iframe', $rootel).attr('height'),10) || maxHeight;

	                    if (width > maxWidth || height > maxHeight) {

	                        var aspectRatio = maxWidth / width;
	                        var newHeight = height * aspectRatio;
	                        var newWidth = maxWidth;

	                        if (newHeight > maxHeight) {
	                            aspectRatio = height / maxHeight;
	                            newHeight = maxHeight;
	                            newWidth = width / aspectRatio;
	                        }

	                        $('iframe', $rootel).attr('height', newHeight);
	                        $('iframe', $rootel).attr('width', newWidth);
	                    }
	                });
	            }
	        });
        };
        init();
    };
});
