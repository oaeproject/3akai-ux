/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery','underscore','oae.core'], function($, _, oae) {

    return function(uid, showSettings) {
		
		// The widget container
		var $rootel = $('#' + uid);
		
		/**
		 * Get Secret: A start point for reseting passord
		 */
		var getSecret = function(){
			$(document).on('submit','#resetpassword-input-username', function(event){

				// disable redirect to other page
				event.preventDefault();

				var username = $.trim($('#resetpassword-username', $(this)).val());

						$.ajax({
								'url': '/api/auth/local/reset/init/'+username,
								'type': 'GET',
								'data': null,
								'success': function(data) {
						
								//callback(null, data);
								oae.api.util.notification('Congratulations!','A Email has been sent to your Email address.');
						
								////// An alternative solution for notification.
								//$('#resetpassword-input-username', $rootel).hide();
								//$('.modal-body').html("<p class='text-center'>Congratulations! A Email has been sent to your Email address.</p>");
								},
								'error': function(data) {
										oae.api.util.notification('Sorry!','The Email has not been sent out!');
								}
						});
			});
		};

		/**
		 * Show the resetpassword form
		 */
		var showResetForm = function() {
					$('#resetpassword-input-username', $rootel).show();
			};
		
		/**
		 * Set focus to input text-box
		 */
		var setFocus = function(){
			$('#resetpassword-modal').on('shown.bs.modal', function () {
					$('#resetpassword-username').focus()
				});
		};
		
		/**
		 * Initialize the resetpassword modal dialog
		 */
		var initResetpassword = function() {
					$(document).on('click', '.oae-trigger-resetpassword', function() {
							// Show the register form and hide the Terms and Conditions
							showResetForm();
				
				// set focus
				setFocus();
				
							// Trigger the modal dialog
							$('#resetpassword-modal', $rootel).modal({
										'toggle':'show',
										'backdrop': 'static'
								});
					});
			
			};
	
		initResetpassword();
		getSecret();
		};
});